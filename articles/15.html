<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>åœ¨ GitHub Action ä¸­è·å–æ”¹åŠ¨æ–‡ä»¶</title>
        <link rel="stylesheet" href="../assets/fonts.css">
        <link rel="stylesheet" href="../assets/graphite.css">
        <link rel="stylesheet" href="../assets/pygments.css">
        
        
    </head>
    <body class="node-articles-15 node-articles node">
        <header class="masthead">
            <h1><a href="../index.html">Oasis's Cloud</a></h1>
            
                <p class="tagline">â˜ï¸ğŸŒµï¸â˜ï¸ğŸŒµï¸â˜ï¸ğŸŒµâ˜ï¸ğŸŒµï¸â˜ï¸ğŸŒµï¸â˜ï¸ğŸŒµâ˜ï¸ğŸŒµ</p>
            
            
            <nav class="menu">
                <input id="menu-check" type="checkbox"/>
                <label id="menu-label" for="menu-check" class="unselectable">
                    <span class="icon close-icon">âœ•</span>
                    <span class="icon open-icon">â˜°</span>
                    <span class="text">Menu</span>
                </label>
                <ul>
<li><a href="../index.html">é¦–é¡µ</a></li>
</ul>
            </nav>
        </header>
        <article class="main">
            <header class="title">
                <h1>åœ¨ GitHub Action ä¸­è·å–æ”¹åŠ¨æ–‡ä»¶</h1>
                
                <hr>
            </header>
            <p>åœ¨ GitHub Action ä¸­å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä¸¤ç§æ–¹å¼æ¥è·å¾—å˜æ›´çš„æ–‡ä»¶ï¼š</p>
<ol>
<li>åœ¨ä»“åº“ä¸‹é€šè¿‡ä½¿ç”¨ <code>git</code> å‘½ä»¤å¯¹æ¯”ä¸¤ä¸ªåˆ†æ”¯ã€‚</li>
<li>å€ŸåŠ© GitHub æä¾›çš„ API æ¥æŸ¥è¯¢å˜æ›´çš„æ–‡ä»¶ã€‚</li>
</ol>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»ç¬¬äºŒç§æ–¹æ³•ï¼Œæˆ‘é‡‡ç”¨ç¬¬äºŒç§æ–¹å¼å®ç°äº†è·å– Pull Request ä¸­çš„å˜æ›´æ–‡ä»¶ï¼Œé’ˆå¯¹å˜æ›´çš„æ–‡ä»¶è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚</p>
<p>GitHub æä¾›äº† <a href="https://docs.github.com/zh/rest/pulls/pulls?apiVersion=2022-11-28#list-pull-requests-files"><code>/repos/{owner}/{repo}/pulls/{pull_number}/files</code></a> API ç”¨äºæŸ¥è¯¢ Pull Request çš„ç›¸å…³å†…å®¹ã€‚</p>
<p>æƒ³è¦è¦ä½¿ç”¨æ­¤ API ï¼Œæˆ‘ä»¬éœ€è¦æä¾› ownerã€repoã€pull number è¿™ä¸‰ä¸ªå‚æ•°çš„å†…å®¹ã€‚ownerã€repo å’Œ pull number å¯ä»¥é€šè¿‡ GitHub Action ä¸­çš„<a href="https://docs.github.com/zh/actions/learn-github-actions/contexts#github-context">ä¸Šä¸‹æ–‡</a>æ¥è·å–ï¼š</p>
<div class="highlight"><pre><span></span><code>name: CI

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Get PR info
        run: |
          echo &quot;PR Message github.event.number: ${{ github.event.number }}&quot;
          echo &quot;PR Message github.repository: ${{ github.repository }}&quot;
</code></pre></div>
<p>è¿™é‡Œç»™å‡ºäº†ä¸€æ®µ GitHub Action çš„è„šæœ¬ï¼Œåœ¨ <code>Get PR info</code> ä»»åŠ¡ä¸­ï¼Œå€ŸåŠ© linux çš„ echo å‘½ä»¤ï¼Œæ‰“å°æ¥ github.event.number å’Œ github.repositoryã€‚æƒ³è¦å¯¹è¿™æ®µè„šæœ¬è¿›è¡Œæµ‹è¯•ï¼Œå¯å°†å…¶æäº¤åˆ° <code>.github/workflows/test.yml</code> ä¸­ï¼Œç„¶åé€šè¿‡å…¶ä»–åˆ†æ”¯å‘ç›®æ ‡åˆ†æ”¯åˆ›å»º PRã€‚ï¼ˆå¤‡æ³¨ï¼š<code>github.event.number</code>æ¥è‡ª<a href="https://docs.github.com/zh/webhooks-and-events/webhooks/webhook-events-and-payloads#pull_request">Webhook çš„å…±æœ‰å±æ€§</a>ï¼‰</p>
<p>é€šè¿‡æ‰§è¡Œä¸Šè¿°ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¾“å‡ºçš„ PR çš„ ID å’Œ repositoryã€‚æ¥ä¸‹æ¥è¦ä½¿ç”¨ä»–ä»¬è°ƒç”¨ GitHub æä¾›çš„ APIã€‚è¿™é‡Œæˆ‘é‡‡ç”¨äº† curl æ¥è¿›è¡Œ GitHub API çš„è°ƒç”¨ï¼š</p>
<div class="highlight"><pre><span></span><code>pr_number=${{ github.event.number }}
files_url=&quot;https://api.github.com/repos/${{ github.repository }}/pulls/$pr_number/files&quot;
files_response=$(curl -sSL -H &quot;Authorization: token ${{ secrets.GITHUB_TOKEN }}&quot; $files_url)
</code></pre></div>
<p>åœ¨è¿™æ®µä»£ç ä¸­å³å­˜åœ¨ <code>${{ xx }}</code> åˆå­˜åœ¨ <code>$xx</code>ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåŒºåˆ†ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ä»€ä¹ˆå½¢å¼ã€‚<code>${{}}</code> æ˜¯ GitHub æä¾›çš„æ’å€¼è¡¨è¾¾å¼ï¼Œåœ¨ GitHub Actions æ‰§è¡Œçš„æ—¶å€™ä¼šå¯¹è¿™ç§è¡¨è¾¾å¼è¿›è¡Œæ±‚å€¼ã€‚ç®€å•ç†è§£çš„è¯ï¼Œå°±æ˜¯å°†è¡¨è¾¾å¼è®¡ç®—å‡ºçš„ç»“æœå¡«åˆ°è„šæœ¬ä¸­ï¼Œç„¶ååœ¨æ‰§è¡Œè„šæœ¬ã€‚<code>$xx</code> æ˜¯ Linux shell çš„å˜é‡è°ƒç”¨çš„æ–¹å¼ï¼Œæ‰€ä»¥åœ¨ GitHub Actions ä¸­æˆ‘ä»¬å®é™…æ‰§è¡Œçš„ä¸»è¦æ˜¯ Linux shell è„šæœ¬ã€‚</p>
<p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œå£°æ˜å˜é‡çš„æ–¹å¼å½¢å¦‚ï¼š
<div class="highlight"><pre><span></span><code><span class="nv">shellVariable</span><span class="o">=</span><span class="m">1</span>
</code></pre></div></p>
<p>è°ƒç”¨å˜é‡çš„æ–¹å¼å½¢å¦‚ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$shellVariable</span><span class="s2">&quot;</span>
</code></pre></div>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»è·å–åˆ°äº† GitHub API è¿”å›çš„ç»“æœï¼Œæ¥ä¸‹æ¥éœ€è¦å¯¹ç»“æœè¿›è¡Œå¤„ç†ï¼Œå³æå–å˜æ›´æ–‡ä»¶ã€‚</p>
<div class="highlight"><pre><span></span><code>files_changed=$(echo &quot;$files_response&quot; | jq -r &#39;.[].filename&#39;)
echo &quot;PR files: $files_changed&quot;
component=$(echo &quot;$files_changed&quot; |  grep -E -i &#39;src\/packages\/([a-z]+)(\/[a-z_\.]*)*&#39; | sed -E &#39;s/src\/packages\/([a-z]+)(\/[a-z_\.]*)*/\1/i&#39; | awk &#39;END{print}&#39;)
npm test -- $component
</code></pre></div>
<p>å› ä¸º GitHub API è¿”å›çš„æ˜¯ JSON æ ¼å¼ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>
  <span class="o">{</span>
    <span class="s2">&quot;sha&quot;</span>: <span class="s2">&quot;bbcd538c8e72b8c175046e27cc8f907076331401&quot;</span>,
    <span class="s2">&quot;filename&quot;</span>: <span class="s2">&quot;src/packages/button/button.tsx&quot;</span>,
    <span class="s2">&quot;status&quot;</span>: <span class="s2">&quot;added&quot;</span>,
    <span class="s2">&quot;additions&quot;</span>: <span class="m">103</span>,
    <span class="s2">&quot;deletions&quot;</span>: <span class="m">21</span>,
    <span class="s2">&quot;changes&quot;</span>: <span class="m">124</span>,
    <span class="s2">&quot;blob_url&quot;</span>: <span class="s2">&quot;https://github.com/octocat/Hello-World/blob/6dcb09b5b57875f334f61aebed695e2e4193db5e/file1.txt&quot;</span>,
    <span class="s2">&quot;raw_url&quot;</span>: <span class="s2">&quot;https://github.com/octocat/Hello-World/raw/6dcb09b5b57875f334f61aebed695e2e4193db5e/file1.txt&quot;</span>,
    <span class="s2">&quot;contents_url&quot;</span>: <span class="s2">&quot;https://api.github.com/repos/octocat/Hello-World/contents/file1.txt?ref=6dcb09b5b57875f334f61aebed695e2e4193db5e&quot;</span>,
    <span class="s2">&quot;patch&quot;</span>: <span class="s2">&quot;@@ -132,7 +132,7 @@ module Test @@ -1000,7 +1000,7 @@ module Test&quot;</span>
  <span class="o">}</span>
<span class="o">]</span>
</code></pre></div>
<p>æ‰€ä»¥æˆ‘ä»¬é€šè¿‡ jq ä» GitHub API è¿”å›çš„ç»“æœä¸­æå–æˆ‘ä»¬éœ€è¦çš„æ•°æ®ï¼Œå³ç¬¬ä¸€è¡Œä»£ç ä¸­çš„ <code>jq -r '.[].filename</code>ï¼Œè¿™å¥ä»£ç çš„æ„æ€æ˜¯å– <code>filename</code> å­—æ®µçš„å€¼ï¼Œç„¶åä»¥åŸå§‹æ–‡æœ¬å½¢å¼è¿”å›ã€‚å¯¹äºä¸Šé¢çš„ JSON æ•°æ®ï¼Œjq çš„å¤„ç†ç»“æœæ˜¯ï¼š<code>src/packages/button/button.tsx</code>ã€‚ï¼ˆ<a href="https://www.tutorialspoint.com/guide-to-linux-jq-command-for-json-processing">jq ä»‹ç»</a>ï¼‰</p>
<p>è·å–å˜æ›´æ–‡ä»¶åï¼Œè¿˜éœ€è¦å°†<code>src/packages/button/button.tsx</code>ä¸­çš„ button æå–å‡ºæ¥ï¼Œä»¥ä¾¿ä¼ é€’ç»™ npm è„šæœ¬ã€‚å¯¹äºå˜æ›´æ–‡ä»¶çš„å¤„ç†ï¼Œä¸»è¦å€ŸåŠ© Linux ä¸­çš„ grepã€sedã€awkã€‚</p>
<p><code>grep -E -i</code> è¡¨ç¤ºä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¹¶ä¸”å¿½ç•¥å¤§å°å†™ã€‚
<code>sed -E</code> åŒæ ·è¡¨ç¤ºä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œä½†æ˜¯å®ƒçš„å¿½ç•¥å¤§å°å†™æ˜¯å†™åˆ°åé¢çš„å‚æ•°ä¸­ã€‚</p>
<p>é€šè¿‡è¿™äº›æ­¥éª¤ï¼Œå°±å¯ä»¥æå– PR ä¸­çš„å˜æ›´æ–‡ä»¶ï¼Œå¯¹æ–‡ä»¶è¿›è¡Œè¿‡æ»¤ï¼Œç„¶åé’ˆå¯¹ç‰¹å®šæ–‡ä»¶æ‰§è¡Œç‰¹å®šçš„å¤„ç†ã€‚</p>
<p>æ€»çš„æ¥è¯´ï¼ŒGitHub æä¾›äº† Actions æ¥å¸®åŠ©æˆ‘ä»¬åšè‡ªåŠ¨åŒ–çš„å¤„ç†ï¼Œå¹¶ä¸”å…è®¸æˆ‘ä»¬é€šè¿‡ yml æ ¼å¼çš„è„šæœ¬æ¥è¿›è¡Œé…ç½®ï¼Œé’ˆå¯¹ yml çš„è„šæœ¬ï¼ŒGitHub æä¾›äº†å†…ç½®çš„å˜é‡ï¼Œé€šè¿‡æ’å€¼æ–¹å¼æä¾›ç»™å¼€å‘è€…ä½¿ç”¨ï¼Œè€Œä¸” run å‘½ä»¤æä¾›ç»™å¼€å‘è€…ä½¿ç”¨ shell çš„ä¾¿æ·æ€§ã€‚</p>
        </article>
        
    </body>
</html>
