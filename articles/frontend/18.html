<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Taro 运行时机制解析</title>
        <link rel="stylesheet" href="../../assets/fonts.css">
        <link rel="stylesheet" href="../../assets/graphite.css">
        <link rel="stylesheet" href="../../assets/pygments.css">
        <script src="../../assets/image-zoom.js" defer></script>
        
        
    </head>
    <body class="node-articles-frontend-18 node-articles-frontend node-articles node">
        <header class="masthead">
            <h1><a href="../../index.html">Oasis's Cloud</a></h1>
            
                <p class="tagline">一个人的首要责任，就是要有雄心。雄心是一种高尚的激情，它可以采取多种合理的形式。<br />—— 《一个数学家的辩白》</p>
            
            
            <nav class="menu">
                <input id="menu-check" type="checkbox"/>
                <label id="menu-label" for="menu-check" class="unselectable">
                    <span class="icon close-icon">✕</span>
                    <span class="icon open-icon">☰</span>
                    <span class="text">Menu</span>
                </label>
                <ul>
<li><a href="../../index.html">首页</a></li>
</ul>
            </nav>
        </header>
        <article class="main">
            <header class="title">
                <h1>Taro 运行时机制解析</h1>
                
                
                    <p class="author">作者：oasis</p>
                
                <hr>
            </header>
            <h2>引言</h2>
<p>本文旨在探索 Taro 如何处理运行时，特别是如何将 React 组件渲染到小程序环境中。核心问题是：<strong>Taro 如何构建出小程序所需的 App、Page 结构，以及如何实现 React 组件树到小程序模板树的映射。</strong></p>
<h2>小程序的基本结构</h2>
<p>小程序运行需要特定的结构和 API。首先了解小程序的基本结构：</p>
<h3>App 结构</h3>
<div class="highlight"><pre><span></span><code><span class="nx">App</span><span class="p">({</span>
<span class="w">    </span><span class="nx">onLaunch</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
<span class="p">})</span>
</code></pre></div>
<h3>Page 结构</h3>
<div class="highlight"><pre><span></span><code><span class="nx">Page</span><span class="p">({</span>
<span class="w">    </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">    </span><span class="nx">onLoad</span><span class="p">()</span><span class="w"> </span><span class="p">{},</span>
<span class="w">    </span><span class="nx">onShow</span><span class="p">()</span><span class="w"> </span><span class="p">{},</span>
<span class="w">    </span><span class="nx">onReady</span><span class="p">()</span><span class="w"> </span><span class="p">{},</span>
<span class="p">})</span>
</code></pre></div>
<p>小程序运行需要上面的这种结构和 API。所以 Taro 工程在编译后应该也具备 App、Page 这些内容。这里的关键要看 <strong>Taro 如何构建出 App、Page 等内容</strong>。</p>
<h3>小程序模板示例</h3>
<div class="highlight"><pre><span></span><code><span class="nx">Page</span><span class="p">({</span>
<span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">demo</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">motto</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Hello World&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">oasis</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;!!!&#39;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="p">})</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;template</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;odd&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;view&gt;</span><span class="w"> </span>{{<span class="w"> </span>demo.motto<span class="w"> </span>}}<span class="w"> </span><span class="nt">&lt;/view&gt;</span>
<span class="nt">&lt;/template&gt;</span>
<span class="nt">&lt;template</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;even&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;view&gt;</span><span class="w"> </span>{{<span class="w"> </span>demo.oasis<span class="w"> </span>}}<span class="w"> </span><span class="nt">&lt;/view&gt;</span>
<span class="nt">&lt;/template&gt;</span>

<span class="nt">&lt;block</span><span class="w"> </span><span class="na">wx:for=</span><span class="s">&quot;{{[1, 2, 3, 4, 5]}}&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;template</span><span class="w"> </span><span class="na">is=</span><span class="s">&quot;{{item % 2 == 0 ? &#39;even&#39; : &#39;odd&#39;}}&quot;</span><span class="w"> </span><span class="na">data=</span><span class="s">&quot;{{ demo }}&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/block&gt;</span>
</code></pre></div>
<h2>Taro 编译后的运行情况</h2>
<h3>Root 数据结构</h3>
<p>源项目中的 <code>pages/index.jsx</code> 中的元素嵌套关系如下：</p>
<p><img alt="img_1.png" src="/images/frontend/img_1.png" /></p>
<p>编译后的 root 数据结构：</p>
<p><img alt="img.png" src="/images/frontend/img.png" /></p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cn</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nx">cl</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;index&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">cn</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">cn</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                        </span><span class="p">{</span>
<span class="w">                            </span><span class="nx">nn</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;8&#39;</span><span class="p">,</span>
<span class="w">                            </span><span class="nx">sid</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;_AG&#39;</span><span class="p">,</span>
<span class="w">                            </span><span class="nx">v</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Hello world!&#39;</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">],</span>
<span class="w">                    </span><span class="nx">nn</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;4&#39;</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">sid</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;_AH&#39;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nx">nn</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">sid</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;_AI&#39;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p>这里可以看做虚拟节点树，实际最终要把这棵树的渲染映射到小程序 xml 模板上。</p>
<p>用最简化的例子来看，<code>pages</code> 下的 <code>index</code> 页面中的 xml 文件加载 <code>base.xml</code> 中的模板，采用编译后的数据 <code>root</code>，进行数据的传递，在通过 <code>xs</code> 计算映射的模板后，最终映射到 <code>tmpl_0_8</code>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;template</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;tmpl_0_8&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;block&gt;</span>{{i.v}}<span class="nt">&lt;/block&gt;</span>
<span class="nt">&lt;/template&gt;</span>
</code></pre></div>
<h3>渲染触发的入口</h3>
<p>实际编译后小程序项目中 <code>pages/index.js</code> 文件内容：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createPageConfig</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@tarojs/runtime&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">component</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;!!../../../node_modules/.pnpm/@tarojs+taro-loader@4.0.0_webpack@5.91.0_@swc+core@1.3.96_/node_modules/@tarojs/taro-loader/lib/entry-cache.js?name=pages/index/index!./index.jsx&quot;</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;navigationBarTitleText&quot;</span><span class="o">:</span><span class="s2">&quot;首页&quot;</span><span class="p">};</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">inst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Page</span><span class="p">(</span><span class="nx">createPageConfig</span><span class="p">(</span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pages/index/index&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">root</span><span class="o">:</span><span class="p">{</span><span class="nx">cn</span><span class="o">:</span><span class="p">[]}},</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{}))</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">component</span>
</code></pre></div>
<p><code>createPageConfig</code> 来自 <code>@tarojs/runtime</code>，这里创建 page json 的静态结构。在这个步骤中，只初始化了 <code>root</code> 数据，实际的数据处理在哪？这个问题比较重要。</p>
<p><code>useState</code> 来自 <code>webpack/container/remote/react</code>，这里在前面创建的数据基础上，由 React 来驱动数据更新。</p>
<p>这里既要考虑小程序渲染模板树的收集，又要考虑 React 如何驱动渲染：</p>
<ul>
<li><strong>小程序渲染树 root 的收集</strong>：主要看 React 渲染机制如何在小程序渲染机制的上层建立</li>
<li><strong>React 如何驱动数据更新</strong>：主要看与 root 数据的关系，React JSX 与小程序 template 的关系</li>
</ul>
<h2>Taro 的架构设计</h2>
<h3>自定义渲染器</h3>
<p>Taro 小程序采用了 React 创建组件，但是渲染采用了基于 <code>react-reconciler</code> 创建的自定义渲染器：</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">TaroReconciler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Reconciler</span><span class="p">(</span><span class="nx">hostConfig</span><span class="p">)</span>
</code></pre></div>
<p><code>TaroReconciler</code> 在封装 render 方法时候，会在 <code>taro-framework-react</code> 的 <code>connect.ts</code> 中调用。<code>createReactApp</code> 设置 <code>setReconciler</code> 层的目的是实现解耦，让 React 层插件化。</p>
<h3>平台适配</h3>
<p><code>taro-platform-weapp</code> 会重新设计 <code>react-reconciler</code>：</p>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">mergeInternalComponents</span><span class="p">,</span><span class="w"> </span><span class="nx">mergeReconciler</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@tarojs/shared&#39;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">components</span><span class="p">,</span><span class="w"> </span><span class="nx">hostConfig</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./runtime-utils&#39;</span>

<span class="nx">mergeReconciler</span><span class="p">(</span><span class="nx">hostConfig</span><span class="p">)</span>
<span class="nx">mergeInternalComponents</span><span class="p">(</span><span class="nx">components</span><span class="p">)</span>
</code></pre></div>
<p><code>taro-framework-react</code> 中会把 React 相关的内容进行 alias 映射：</p>
<div class="highlight"><pre><span></span><code><span class="nx">alias</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;react-reconciler$&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;react-reconciler/cjs/react-reconciler.production.min.js&#39;</span><span class="p">)</span>
<span class="nx">alias</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="sr">/^(?!.*mobx-react$).*react$/</span><span class="p">,</span><span class="w"> </span><span class="nx">newFilePath</span><span class="p">)</span>
<span class="nx">alias</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;react/jsx-runtime$&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;react/cjs/react-jsx-runtime.production.min.js&#39;</span><span class="p">)</span>
</code></pre></div>
<h3>Taro3 的解释型架构</h3>
<p>Taro3 可以大致理解为<strong>解释型架构</strong>，这个工作主要是在运行时&rdquo;对代码进行解释&rdquo;。</p>
<p>升级为 Taro3 后，你会发现 <code>package.json</code> 文件里面多了个 <code>@taro/runtime</code> 的依赖。打开包所在目录，会惊奇的发现我们在 web 中才会有的 BOM 跟 DOM 相关的关键字。原来 Taro3 自己实现了一套类似浏览器的 BOM/DOM 那一套 API，通过 webpack 的 plugin 注入到小程序的逻辑层。</p>
<p>打包编译后，你最终的代码都是基于 BOM/DOM 这几个 API 来实现你的具体功能。不管什么平台，都有自己一套元素 dom 的规则，都有各自平台的类似 bom 的全局 api 规则，Taro3 做的就是整合这些厂家的规则封装为类似 BOM/DOM 的思想去用。也就是说，我不管你开发时用的什么框架，我只要保证你运行时能帮你适配到各个平台即可。</p>
<p>这样做的最直观的好处就是，不再受限制与框架本身了。理论上来说，Taro 不仅可以支持 Vue 和 React，也能用 jQuery、Angular 等等的库进行跨端开发。</p>
<p>站在 React 的使用者角度：通过 taro2 和 taro3 两个项目开发经验来说，还有一点最直观的感受，taro3 中写 JSX 更加舒服了！其实就更加友好的支持 JSX 这一点，应该是顺理成章的，因为 taro 的架构其实就是无限接近于 React 的开发体验，适配的工作是通过运行时的 BOM/DOM 去完成的，而不是像之前版本一样，通过穷举的方式对 JSX 的写法进行适配。</p>
<p><strong>关键点</strong>：既然 Taro3 自己实现了 BOM/DOM 这一套 API，而 React 中的渲染器，如 <code>react-dom</code> 中调用的是浏览器的 BOM/DOM 的 API，那 Taro 肯定会有自己一套渲染器来链接 React 的协调器（reconciler，diff 算法所在阶段）和 taro-runtime 的 BOM/DOM API。源码路径：<code>@tarojs/react</code>，description 里面的描述如下：&rdquo;like react-dom, but for mini apps.&rdquo;</p>
<h3>数据流概览</h3>
<ul>
<li>Root 数据的初始化在 <code>createReactApp</code> 中完成</li>
<li>数据更新由 <code>TaroRootElement</code> 负责管理</li>
<li>实际渲染由 ReactDOM 的 Root 类处理</li>
<li>最终通过小程序的 <code>setData</code> 实现真实 DOM 更新</li>
</ul>
<h2>核心机制详解</h2>
<h3>createReactApp</h3>
<p><code>createReactApp</code> 方法是 Taro 框架的一个核心方法，用于创建 React 应用并将其适配到小程序环境。</p>
<h4>主要功能和实现细节</h4>
<p><strong>初始化设置</strong>：
- 接收主要参数：App 组件、React 实例、ReactDOM 实例和配置对象
- 设置 React 相关的全局引用
- 创建应用实例的引用</p>
<p><strong>AppWrapper 核心组件</strong>：
- 继承自 <code>React.Component</code>
- 管理页面的生命周期
- 维护页面数组和元素数组
- 提供页面挂载和卸载的方法</p>
<p><strong>页面管理</strong>：
- <code>mount</code> 方法：负责新页面的挂载
- <code>unmount</code> 方法：处理页面的卸载
- 使用 <code>connectReactPage</code> 连接 React 组件与小程序页面</p>
<p><strong>渲染机制</strong>：
- 使用 React 18 的新 API 或降级使用旧版本的渲染方式
- 处理页面栈的管理和渲染
- 支持异步的页面加载和卸载</p>
<p><strong>生命周期适配</strong>：
- 将 React 的生命周期与小程序的生命周期进行对接
- 处理页面切换和状态管理</p>
<p>这个实现的主要目的是：
- 让 React 组件能够在小程序环境中正常运行
- 处理好小程序的页面栈管理
- 确保 React 组件的生命周期能够正确响应小程序的事件
- 提供统一的页面管理机制</p>
<p>通过这种方式，开发者可以使用熟悉的 React 组件开发方式来开发小程序，而 Taro 框架则负责处理底层的适配工作。</p>
<h3>TaroRootElement 数据收集机制</h3>
<p><code>TaroRootElement</code> 中的 <code>performUpdate</code> 会收集 data 数据，并调用小程序的 <code>setData</code> 更新数据。</p>
<h4>数据收集流程</h4>
<p><strong>1. TaroNode 类中的基础节点操作</strong></p>
<div class="highlight"><pre><span></span><code><span class="nx">TaroNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">_TaroNode</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">TaroEventTarget</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">updateChildNodes</span><span class="p">(</span><span class="nx">isClean</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">cleanChildNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">[];</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">rerenderChildNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">childNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="nx">isComment</span><span class="p">(</span><span class="nx">node</span><span class="p">));</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">hydrate</span><span class="p">);</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">enqueueUpdate</span><span class="p">({</span>
<span class="w">            </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">_path</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">CHILDNODES</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">            </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">isClean</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">cleanChildNodes</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">rerenderChildNodes</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>这里定义了 <code>updateChildNodes</code> 方法，它负责收集和更新子节点数据。当子节点发生变化时，会调用 <code>hydrate</code> 方法处理每个子节点。</p>
<p><strong>2. hydrate 方法</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">hydrate</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">_a2</span><span class="p">;</span>
<span class="w">    </span><span class="nx">componentsAlias2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">componentsAlias2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getComponentsAlias2</span><span class="p">());</span>
<span class="w">    </span><span class="nx">SPECIAL_NODES</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">SPECIAL_NODES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_chunk_KEK4XUFF_js__WEBPACK_IMPORTED_MODULE_0__</span><span class="p">.</span><span class="nx">hooks</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;getSpecialNodes&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">nodeName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">compileModeName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isText</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">sid</span><span class="o">:</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">sid</span><span class="p">,</span>
<span class="w">            </span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeValue</span><span class="p">,</span>
<span class="w">            </span><span class="p">[</span><span class="s2">&quot;nn&quot;</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="p">((</span><span class="nx">_a2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">componentsAlias2</span><span class="p">[</span><span class="nx">nodeName</span><span class="p">])</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">_a2</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">_a2</span><span class="p">.</span><span class="nx">_num</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;8&quot;</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">[</span><span class="s2">&quot;nn&quot;</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="nx">nodeName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sid</span><span class="o">:</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">sid</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">uid</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">sid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">data</span><span class="p">.</span><span class="nx">uid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">uid</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">node</span><span class="p">.</span><span class="nx">isAnyEventBinded</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">SPECIAL_NODES</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">nodeName</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">data</span><span class="p">[</span><span class="s2">&quot;nn&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`static-</span><span class="si">${</span><span class="nx">nodeName</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nodeName</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">VIEW</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">isHasExtractProp</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">data</span><span class="p">[</span><span class="s2">&quot;nn&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">PURE_VIEW</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">props</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">node</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p>这个方法负责将节点转换为小程序可以理解的数据格式，包括：
- 节点 ID（sid）
- 节点名称（nn）
- 节点值（v）
- 特殊节点的处理</p>
<p><strong>3. 节点的插入和删除操作</strong></p>
<div class="highlight"><pre><span></span><code><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">newChild</span><span class="p">,</span><span class="w"> </span><span class="nx">refChild</span><span class="p">,</span><span class="w"> </span><span class="nx">isReplace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">newChild</span><span class="p">.</span><span class="nx">nodeName</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">DOCUMENT_FRAGMENT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_root</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">refChild</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">isOnlyChild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">childNodesLength</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isOnlyChild</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="nx">updateChildNodes</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="nx">enqueueUpdate</span><span class="p">({</span>
<span class="w">                    </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="nx">newChild</span><span class="p">.</span><span class="nx">_path</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">hydrate</span><span class="p">(</span><span class="nx">newChild</span><span class="p">)</span>
<span class="w">                </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isReplace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">enqueueUpdate</span><span class="p">({</span>
<span class="w">                </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="nx">newChild</span><span class="p">.</span><span class="nx">_path</span><span class="p">,</span>
<span class="w">                </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">hydrate</span><span class="p">(</span><span class="nx">newChild</span><span class="p">)</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">mark</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">childNodesLength</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">3</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mark</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="nx">updateChildNodes</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="nx">updateSingleChild</span><span class="p">(</span><span class="nx">index</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">MutationObserver2</span><span class="p">.</span><span class="nx">record</span><span class="p">({</span>
<span class="w">        </span><span class="nx">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;childList&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">target</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">,</span>
<span class="w">        </span><span class="nx">addedNodes</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">newChild</span><span class="p">],</span>
<span class="w">        </span><span class="nx">removedNodes</span><span class="o">:</span><span class="w"> </span><span class="nx">isReplace</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">[</span><span class="nx">refChild</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nx">nextSibling</span><span class="o">:</span><span class="w"> </span><span class="nx">isReplace</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">refChild</span><span class="p">.</span><span class="nx">nextSibling</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">refChild</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">        </span><span class="nx">previousSibling</span><span class="o">:</span><span class="w"> </span><span class="nx">newChild</span><span class="p">.</span><span class="nx">previousSibling</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">newChild</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>在 <code>insertBefore</code> 方法中，会根据不同情况选择更新策略：
- 如果是唯一子节点，更新整个子节点树
- 如果有参考节点，更新单个节点
- 根据节点位置决定是更新整个树还是单个节点</p>
<p><strong>4. 数据更新的入队</strong></p>
<div class="highlight"><pre><span></span><code><span class="nx">enqueueUpdate</span><span class="p">(</span><span class="nx">payload</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">_a2</span><span class="p">;</span>
<span class="w">    </span><span class="p">(</span><span class="nx">_a2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_root</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">_a2</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">_a2</span><span class="p">.</span><span class="nx">enqueueUpdate</span><span class="p">(</span><span class="nx">payload</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>所有节点的更新都会通过 <code>enqueueUpdate</code> 方法进入更新队列。</p>
<p><strong>5. 最终在 performUpdate 中处理更新</strong></p>
<div class="highlight"><pre><span></span><code><span class="nx">performUpdate</span><span class="p">(</span><span class="nx">initRender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">prerender</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">pendingUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_chunk_KEK4XUFF_js__WEBPACK_IMPORTED_MODULE_0__</span><span class="p">.</span><span class="nx">hooks</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;proxyToRaw&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">ctx</span><span class="p">);</span>
<span class="w">    </span><span class="nx">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">setDataMark</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">SET_DATA</span><span class="si">}</span><span class="sb"> 开始时间戳 </span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">        </span><span class="nx">perf</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">setDataMark</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* @__PURE__ */</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">resetPaths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">(</span><span class="nx">initRender</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;root.cn.[0]&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;root.cn[0]&quot;</span>
<span class="w">        </span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[]);</span>
<span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">updatePayloads</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">updatePayloads</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s2">&quot;cn&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">resetPaths</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">data</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">value</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">resetPaths</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="ow">delete</span><span class="w"> </span><span class="nx">data</span><span class="p">[</span><span class="nx">path</span><span class="p">];</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">[</span><span class="nx">path</span><span class="p">];</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="mf">0</span><span class="p">,</span><span class="nx">_chunk_KEK4XUFF_js__WEBPACK_IMPORTED_MODULE_0__</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">)(</span><span class="nx">value</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">data</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">value</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="mf">0</span><span class="p">,</span><span class="nx">_chunk_KEK4XUFF_js__WEBPACK_IMPORTED_MODULE_0__</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">)(</span><span class="nx">prerender</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">prerender</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">pendingUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">normalUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">customWrapperMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cm">/* @__PURE__ */</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">initRender</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">normalUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">dataPathArr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">p</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">findCustomWrapper</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">dataPathArr</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">found</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">customWrapper</span><span class="p">,</span><span class="w"> </span><span class="nx">splitedPath</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">found</span><span class="p">;</span>
<span class="w">                    </span><span class="nx">customWrapperMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">customWrapper</span><span class="p">,</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span><span class="w"> </span><span class="nx">customWrapperMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">customWrapper</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{}),</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="p">[</span><span class="sb">`i.</span><span class="si">${</span><span class="nx">splitedPath</span><span class="si">}</span><span class="sb">`</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span>
<span class="w">                    </span><span class="p">}));</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">normalUpdate</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">[</span><span class="nx">p</span><span class="p">];</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">customWrapperCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">customWrapperMap</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">isNeedNormalUpdate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">normalUpdate</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">updateArrLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">customWrapperCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">isNeedNormalUpdate</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">executeTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="nx">executeTime</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">updateArrLen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">perf</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">setDataMark</span><span class="p">);</span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="nx">flushUpdateCallback</span><span class="p">();</span>
<span class="w">                </span><span class="nx">initRender</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">perf</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">PAGE_INIT</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">customWrapperCount</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">customWrapperMap</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">data2</span><span class="p">,</span><span class="w"> </span><span class="nx">ctx2</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">debug</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;custom wrapper setData: &quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">data2</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="nx">ctx2</span><span class="p">.</span><span class="nx">setData</span><span class="p">(</span><span class="nx">data2</span><span class="p">,</span><span class="w"> </span><span class="nx">cb</span><span class="p">);</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isNeedNormalUpdate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">debug</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;page setData:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">normalUpdate</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">setData</span><span class="p">(</span><span class="nx">normalUpdate</span><span class="p">,</span><span class="w"> </span><span class="nx">cb</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>这个方法会：
- 收集所有待更新的数据
- 处理更新路径
- 区分普通更新和自定义组件更新
- 最终通过 <code>setData</code> 更新到视图层</p>
<p>整个过程形成了一个完整的数据收集链路：
- 节点变化触发更新
- 更新进入队列
- <code>hydrate</code> 处理节点数据
- <code>performUpdate</code> 统一处理更新
- <code>setData</code> 更新到视图层</p>
<p>这样的设计确保了 React 组件树的变化能够被正确地收集和同步到小程序的数据层。</p>
<h3>createReactApp 和 Page 中的数据通信</h3>
<p>从代码中可以看出，<code>createReactApp</code> 和 Page 的数据通信主要通过以下几个关键步骤：</p>
<p><strong>1. 在 createReactApp 中创建 AppWrapper 组件，它负责管理所有页面：</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">AppWrapper</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">react</span><span class="p">.</span><span class="nx">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mount</span><span class="p">(</span><span class="nx">pageComponent</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">cb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">pageWrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">connectReactPage</span><span class="p">(</span><span class="nx">react</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">)(</span><span class="nx">pageComponent</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">pageKeyId</span><span class="p">();</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">h$1</span><span class="p">(</span><span class="nx">pageWrapper</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">key</span><span class="p">,</span>
<span class="w">            </span><span class="nx">tid</span><span class="o">:</span><span class="w"> </span><span class="nx">id</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">pages</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">page</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">forceUpdate</span><span class="p">((...</span><span class="nx">args</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">_chunk_R2V3WQ7B_js__WEBPACK_IMPORTED_MODULE_0__</span><span class="p">.</span><span class="nx">perf</span><span class="p">.</span><span class="nx">stop</span><span class="p">(</span><span class="nx">_chunk_R2V3WQ7B_js__WEBPACK_IMPORTED_MODULE_0__</span><span class="p">.</span><span class="nx">PAGE_INIT</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">cb</span><span class="p">(...</span><span class="nx">args</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">unmount</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">cb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">elements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">elements</span><span class="p">;</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">elements</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">((</span><span class="nx">item</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">item</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">tid</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">id</span><span class="p">);</span>
<span class="w">        </span><span class="nx">elements</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">idx</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">forceUpdate</span><span class="p">(</span><span class="nx">cb</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">render</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">pages</span><span class="p">,</span><span class="w"> </span><span class="nx">elements</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="w">        </span><span class="k">while</span><span class="p">(</span><span class="nx">pages</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pages</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
<span class="w">            </span><span class="nx">elements</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">page</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>2. 当页面需要挂载时，通过 connectReactPage 创建页面包装器：</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">connectReactPage</span><span class="p">(</span><span class="nx">R</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">Page</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">isReactComponent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">isClassComponent</span><span class="p">(</span><span class="nx">R</span><span class="p">,</span><span class="w"> </span><span class="nx">Page</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">inject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="nx">_chunk_R2V3WQ7B_js__WEBPACK_IMPORTED_MODULE_0__</span><span class="p">.</span><span class="nx">injectPageInstance</span><span class="p">)(</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">refs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">isReactComponent</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">ref</span><span class="o">:</span><span class="w"> </span><span class="nx">inject</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">forwardedRef</span><span class="o">:</span><span class="w"> </span><span class="nx">inject</span><span class="p">,</span>
<span class="w">            </span><span class="c1">// 兼容 react-redux 7.20.1+</span>
<span class="w">            </span><span class="nx">reactReduxForwardedRef</span><span class="o">:</span><span class="w"> </span><span class="nx">inject</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">reactMeta</span><span class="p">.</span><span class="nx">PageContext</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">_chunk_KEK4XUFF_js__WEBPACK_IMPORTED_MODULE_1__</span><span class="p">.</span><span class="nx">EMPTY_OBJ</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">reactMeta</span><span class="p">.</span><span class="nx">PageContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">R</span><span class="p">.</span><span class="nx">createContext</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PageWrapper</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">R</span><span class="p">.</span><span class="nx">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">static</span><span class="w"> </span><span class="nx">getDerivedStateFromError</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">var</span><span class="w"> </span><span class="nx">_a</span><span class="p">,</span><span class="w"> </span><span class="nx">_b</span><span class="p">;</span>
<span class="w">                </span><span class="p">(</span><span class="nx">_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_chunk_R2V3WQ7B_js__WEBPACK_IMPORTED_MODULE_0__</span><span class="p">.</span><span class="nx">Current</span><span class="p">.</span><span class="nx">app</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">_a</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">_a</span><span class="p">.</span><span class="nx">onError</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">_b</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">_b</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">_a</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">hasError</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">                </span><span class="p">};</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="c1">// React 16 uncaught error 会导致整个应用 crash，</span>
<span class="w">            </span><span class="c1">// 目前把错误缩小到页面</span>
<span class="w">            </span><span class="nx">componentDidCatch</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">info</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="w">                    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">componentStack</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">render</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">const</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">hasError</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">h$1</span><span class="p">(</span><span class="nx">reactMeta</span><span class="p">.</span><span class="nx">PageContext</span><span class="p">.</span><span class="nx">Provider</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="nx">id</span>
<span class="w">                </span><span class="p">},</span><span class="w"> </span><span class="nx">h$1</span><span class="p">(</span><span class="nx">Page</span><span class="p">,</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">),</span><span class="w"> </span><span class="nx">refs</span><span class="p">)));</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="nx">h$1</span><span class="p">(</span><span class="s2">&quot;root&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">id</span>
<span class="w">                    </span><span class="p">},</span><span class="w"> </span><span class="nx">children</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">super</span><span class="p">(...</span><span class="nx">arguments</span><span class="p">);</span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">hasError</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">                </span><span class="p">};</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>3. 页面配置通过 createPageConfig 创建，在这里处理页面的生命周期和数据更新：</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">createPageConfig</span><span class="p">(</span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">pageName</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">pageConfig</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pageName</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">pageName</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">pageName</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="sb">`taro_page_</span><span class="si">${</span><span class="nx">pageId</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">ONLOAD</span><span class="p">,</span><span class="w"> </span><span class="nx">ONUNLOAD</span><span class="p">,</span><span class="w"> </span><span class="nx">ONREADY</span><span class="p">,</span><span class="w"> </span><span class="nx">ONSHOW</span><span class="p">,</span><span class="w"> </span><span class="nx">ONHIDE</span><span class="p">,</span><span class="w"> </span><span class="nx">LIFECYCLES</span><span class="p">,</span><span class="w"> </span><span class="nx">SIDE_EFFECT_LIFECYCLES</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_chunk_KEK4XUFF_js__WEBPACK_IMPORTED_MODULE_0__</span><span class="p">.</span><span class="nx">hooks</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;getMiniLifecycleImpl&quot;</span><span class="p">).</span><span class="nx">page</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">pageElement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">unmounting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">prepareMountList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">setCurrentRouter</span><span class="p">(</span><span class="nx">page</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">route</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">__route__</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">$taroPath</span><span class="p">;</span>
<span class="w">        </span><span class="nx">Current</span><span class="p">.</span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">$taroParams</span><span class="p">,</span>
<span class="w">            </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="nx">addLeadingSlash</span><span class="p">(</span><span class="nx">router</span><span class="p">),</span>
<span class="w">            </span><span class="nx">$taroPath</span><span class="o">:</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">$taroPath</span><span class="p">,</span>
<span class="w">            </span><span class="nx">onReady</span><span class="o">:</span><span class="w"> </span><span class="nx">getOnReadyEventKey</span><span class="p">(</span><span class="nx">id</span><span class="p">),</span>
<span class="w">            </span><span class="nx">onShow</span><span class="o">:</span><span class="w"> </span><span class="nx">getOnShowEventKey</span><span class="p">(</span><span class="nx">id</span><span class="p">),</span>
<span class="w">            </span><span class="nx">onHide</span><span class="o">:</span><span class="w"> </span><span class="nx">getOnHideEventKey</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="nx">_chunk_KEK4XUFF_js__WEBPACK_IMPORTED_MODULE_0__</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">)(</span><span class="nx">page</span><span class="p">.</span><span class="nx">exitState</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">Current</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">exitState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">exitState</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">loadResolver</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">hasLoaded</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">[</span><span class="nx">ONLOAD</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nx">options2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="nx">cb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">hasLoaded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">loadResolver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">resolve</span><span class="p">;</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">            </span><span class="nx">perf</span><span class="p">.</span><span class="nx">start</span><span class="p">(</span><span class="nx">PAGE_INIT</span><span class="p">);</span>
<span class="w">            </span><span class="nx">Current</span><span class="p">.</span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pageConfig</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{};</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">uniqueOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span><span class="w"> </span><span class="nx">options2</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">$taroTimestamp</span><span class="o">:</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">$taroPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">$taroPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getPath</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">uniqueOptions</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$taroParams</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">this</span><span class="p">.</span><span class="nx">$taroParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uniqueOptions</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">setCurrentRouter</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">window2</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">CONTEXT_ACTIONS</span><span class="p">.</span><span class="nx">INIT</span><span class="p">,</span><span class="w"> </span><span class="nx">$taroPath</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="kd">const</span><span class="w"> </span><span class="nx">mount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">Current</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">mount</span><span class="p">(</span><span class="nx">component</span><span class="p">,</span><span class="w"> </span><span class="nx">$taroPath</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">pageElement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">env</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">$taroPath</span><span class="p">);</span>
<span class="w">                    </span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="nx">_chunk_KEK4XUFF_js__WEBPACK_IMPORTED_MODULE_0__</span><span class="p">.</span><span class="nx">ensure</span><span class="p">)(</span><span class="nx">pageElement</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;没有找到页面实例。&quot;</span><span class="p">);</span>
<span class="w">                    </span><span class="nx">safeExecute</span><span class="p">(</span><span class="nx">$taroPath</span><span class="p">,</span><span class="w"> </span><span class="nx">ON_LOAD</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">$taroParams</span><span class="p">);</span>
<span class="w">                    </span><span class="nx">loadResolver</span><span class="p">();</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">pageElement</span><span class="p">.</span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="w">                        </span><span class="nx">pageElement</span><span class="p">.</span><span class="nx">performUpdate</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">cb</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{}</span>
<span class="w">                </span><span class="p">});</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">unmounting</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">prepareMountList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">mount</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">mount</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<h4>主要通信流程</h4>
<p><strong>数据流向</strong>：
- <code>AppWrapper</code> 维护页面栈
- 通过 <code>mount/unmount</code> 方法管理页面的加载和卸载
- 页面实例通过 <code>performUpdate</code> 方法更新数据
- 最终通过小程序的 <code>setData</code> 实现数据同步</p>
<p><strong>更新机制</strong>：
- 页面更新时会调用 <code>TaroRootElement</code> 的 <code>performUpdate</code>（见上一节）</p>
<p><strong>事件处理</strong>：
- React 事件通过 <code>unstable_batchedUpdates</code> 处理批量更新</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">unstable_batchedUpdates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span><span class="w"> </span><span class="nx">a</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isInsideEventHandler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">fn</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">isInsideEventHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">TaroReconciler</span><span class="p">.</span><span class="nx">batchedUpdates</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span><span class="w"> </span><span class="nx">a</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">isInsideEventHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="nx">finishEventHandler</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p>整个通信过程形成了一个完整的链路：
- <code>createReactApp</code> 创建应用实例
- <code>connectReactPage</code> 连接 React 组件与小程序页面
- <code>createPageConfig</code> 处理页面配置和生命周期
- <code>performUpdate</code> 统一处理数据更新
- <code>setData</code> 同步到小程序层</p>
<p>这样的设计确保了 React 组件和小程序页面之间的数据能够保持同步，同时保持了各自的生命周期管理。</p>
<h3>AppWrapper 页面栈管理</h3>
<h4>页面栈维护机制</h4>
<p><strong>1. AppWrapper 通过两个数组维护页面状态：</strong></p>
<ul>
<li><code>this.pages</code>：存储待渲染的页面组件</li>
<li><code>this.elements</code>：存储已渲染的页面元素</li>
</ul>
<p><strong>2. 页面切换时的数据处理：</strong></p>
<p>在 <code>createPageConfig</code> 中，通过 <code>Current</code> 对象维护当前页面的状态：
- <code>Current.page</code>：当前页面实例
- <code>Current.router</code>：当前路由信息
- <code>Current.app</code>：应用实例</p>
<p><strong>3. 页面间共享数据的方式：</strong></p>
<p><strong>a. 通过 Current 对象：</strong></p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">setCurrentRouter</span><span class="p">(</span><span class="nx">page</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">route</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">__route__</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">$taroPath</span><span class="p">;</span>
<span class="w">    </span><span class="nx">Current</span><span class="p">.</span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">$taroParams</span><span class="p">,</span>
<span class="w">        </span><span class="nx">path</span><span class="o">:</span><span class="w"> </span><span class="nx">addLeadingSlash</span><span class="p">(</span><span class="nx">router</span><span class="p">),</span>
<span class="w">        </span><span class="nx">$taroPath</span><span class="o">:</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">$taroPath</span><span class="p">,</span>
<span class="w">        </span><span class="nx">onReady</span><span class="o">:</span><span class="w"> </span><span class="nx">getOnReadyEventKey</span><span class="p">(</span><span class="nx">id</span><span class="p">),</span>
<span class="w">        </span><span class="nx">onShow</span><span class="o">:</span><span class="w"> </span><span class="nx">getOnShowEventKey</span><span class="p">(</span><span class="nx">id</span><span class="p">),</span>
<span class="w">        </span><span class="nx">onHide</span><span class="o">:</span><span class="w"> </span><span class="nx">getOnHideEventKey</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="nx">_chunk_KEK4XUFF_js__WEBPACK_IMPORTED_MODULE_0__</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">)(</span><span class="nx">page</span><span class="p">.</span><span class="nx">exitState</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">Current</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">exitState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">exitState</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>Current</code> 对象作为全局状态管理器，可以在不同页面间共享数据。</p>
<p><strong>b. 通过 PageContext：</strong></p>
<p>React 的 Context 机制用于跨组件传递数据。</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">reactMeta</span><span class="p">.</span><span class="nx">PageContext</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">_chunk_KEK4XUFF_js__WEBPACK_IMPORTED_MODULE_1__</span><span class="p">.</span><span class="nx">EMPTY_OBJ</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">reactMeta</span><span class="p">.</span><span class="nx">PageContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">R</span><span class="p">.</span><span class="nx">createContext</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h2>总结</h2>
<p>Taro 的运行时机制通过以下几个核心部分实现了 React 到小程序的适配：</p>
<ol>
<li><strong>自定义渲染器</strong>：基于 <code>react-reconciler</code> 创建，连接 React 协调器和小程序的 BOM/DOM API</li>
<li><strong>数据收集</strong>：通过 <code>TaroRootElement</code> 和 <code>TaroNode</code> 收集 React 组件树的变化</li>
<li><strong>数据同步</strong>：通过 <code>performUpdate</code> 和 <code>setData</code> 将数据同步到小程序视图层</li>
<li><strong>页面管理</strong>：通过 <code>AppWrapper</code> 和 <code>createPageConfig</code> 管理小程序页面栈和生命周期</li>
<li><strong>状态共享</strong>：通过 <code>Current</code> 对象和 <code>PageContext</code> 实现页面间数据共享</li>
</ol>
<p>这样的架构设计使得开发者可以使用熟悉的 React 开发方式，而 Taro 框架负责处理底层的适配工作，实现了&rdquo;一次编写，多端运行&rdquo;的目标。</p>
<p><img alt="img.png" src="/images/frontend/img.png" /></p>
        </article>
        
        <script src="https://giscus.app/client.js"
                data-repo="oasis-cloud/blog-comments"
                data-repo-id="R_kgDOKEliHA"
                data-category="General"
                data-category-id="DIC_kwDOKEliHM4CYb6e"
                data-mapping="pathname"
                data-strict="0"
                data-reactions-enabled="1"
                data-emit-metadata="0"
                data-input-position="bottom"
                data-theme="preferred_color_scheme"
                data-lang="zh-CN"
                crossorigin="anonymous"
                async>
        </script>
    </body>
</html>
