<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Oasis's Cloud</title>
        <link rel="stylesheet" href="../../../assets/fonts.css">
        <link rel="stylesheet" href="../../../assets/graphite.css">
        <link rel="stylesheet" href="../../../assets/pygments.css">
        <script src="../../../assets/image-zoom.js" defer></script>
        
        
    </head>
    <body class="node-articles-frontend-nextjs-03-http node-articles-frontend-nextjs node-articles-frontend node-articles node">
        <header class="masthead">
            <h1><a href="../../../index.html">Oasis's Cloud</a></h1>
            
                <p class="tagline">ä¸€ä¸ªäººçš„é¦–è¦è´£ä»»ï¼Œå°±æ˜¯è¦æœ‰é›„å¿ƒã€‚é›„å¿ƒæ˜¯ä¸€ç§é«˜å°šçš„æ¿€æƒ…ï¼Œå®ƒå¯ä»¥é‡‡å–å¤šç§åˆç†çš„å½¢å¼ã€‚<br />â€”â€” ã€Šä¸€ä¸ªæ•°å­¦å®¶çš„è¾©ç™½ã€‹</p>
            
            
            <nav class="menu">
                <input id="menu-check" type="checkbox"/>
                <label id="menu-label" for="menu-check" class="unselectable">
                    <span class="icon close-icon">âœ•</span>
                    <span class="icon open-icon">â˜°</span>
                    <span class="text">Menu</span>
                </label>
                <ul>
<li><a href="../../../index.html">é¦–é¡µ</a></li>
</ul>
            </nav>
        </header>
        <article class="main">
            <header class="title">
                <h1></h1>
                
                
                <hr>
            </header>
            <h1>03. å¼€å‘æœåŠ¡å™¨ï¼šHTTP æœåŠ¡å™¨å’Œè¯·æ±‚å¤„ç†</h1>
<h2>æ¦‚è¿°</h2>
<p>å¼€å‘æœåŠ¡å™¨æ˜¯ Next.js çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒè´Ÿè´£å¯åŠ¨ HTTP æœåŠ¡å™¨ã€å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ã€åŒ¹é…è·¯ç”±å¹¶æ¸²æŸ“é¡µé¢ã€‚æœ¬æ–‡å°†æ·±å…¥åˆ†æå¹¶å®ç°å¼€å‘æœåŠ¡å™¨çš„æ ¸å¿ƒåŠŸèƒ½ã€‚</p>
<h2>æ ¸å¿ƒåŠŸèƒ½åˆ†æ</h2>
<h3>1. HTTP æœåŠ¡å™¨</h3>
<p><strong>èŒè´£</strong>ï¼š
- å¯åŠ¨ HTTP æœåŠ¡å™¨
- ç›‘å¬æŒ‡å®šç«¯å£
- å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚</p>
<p><strong>æŠ€æœ¯é€‰æ‹©</strong>ï¼š
- ä½¿ç”¨ Node.js åŸç”Ÿ <code>http</code> æ¨¡å—
- ç®€å•ã€è½»é‡ï¼Œæ— éœ€é¢å¤–ä¾èµ–</p>
<h3>2. è¯·æ±‚å¤„ç†æµç¨‹</h3>
<div class="highlight"><pre><span></span><code>HTTP è¯·æ±‚
    â†“
è§£æ URL
    â†“
è·¯ç”±åŒ¹é…
    â†“
åŠ è½½ç»„ä»¶
    â†“
æ¸²æŸ“ HTML
    â†“
è¿”å›å“åº”
</code></pre></div>
<h3>3. è·¯ç”±å¤„ç†</h3>
<p><strong>èŒè´£</strong>ï¼š
- æ ¹æ® URL è·¯å¾„åŒ¹é…è·¯ç”±
- å¤„ç†é™æ€è·¯ç”±å’ŒåŠ¨æ€è·¯ç”±
- æå–æŸ¥è¯¢å‚æ•°å’ŒåŠ¨æ€å‚æ•°</p>
<h3>4. é™æ€èµ„æºæœåŠ¡</h3>
<p><strong>èŒè´£</strong>ï¼š
- æœåŠ¡ <code>public</code> ç›®å½•ä¸‹çš„é™æ€æ–‡ä»¶
- è®¾ç½®æ­£ç¡®çš„ Content-Type
- å¤„ç† 404 æƒ…å†µ</p>
<h3>5. API è·¯ç”±å¤„ç†</h3>
<p><strong>èŒè´£</strong>ï¼š
- å¤„ç† <code>/api/*</code> è·¯å¾„
- æ‰§è¡Œ API å¤„ç†å‡½æ•°
- è¿”å› JSON å“åº”</p>
<h2>é€æ­¥å®ç°</h2>
<h3>æ­¥éª¤ 1ï¼šåˆ›å»ºæœåŠ¡å™¨ç±»ç»“æ„</h3>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;http&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;fs&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;path&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileSystemRouter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../router/file-system-router.js&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ModuleLoader</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../utils/module-loader.js&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">renderFullPage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../renderer/ssr-renderer.js&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">DevServer</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">dir</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">port</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">3000</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">hostname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">hostname</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;localhost&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">pagesDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dir</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pages&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">publicDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dir</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;public&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FileSystemRouter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pagesDir</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">moduleLoader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ModuleLoader</span><span class="p">();</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>è®¾è®¡è¯´æ˜</strong>ï¼š
- æ¥å—é…ç½®é€‰é¡¹ï¼ˆç›®å½•ã€ç«¯å£ã€ä¸»æœºåï¼‰
- åˆå§‹åŒ–è·¯ç”±ç³»ç»Ÿå’Œæ¨¡å—åŠ è½½å™¨
- å‡†å¤‡ç›®å½•è·¯å¾„</p>
<h3>æ­¥éª¤ 2ï¼šå®ç°æœåŠ¡å™¨å¯åŠ¨</h3>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="nx">start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨...`</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`ğŸ“ é¡¹ç›®ç›®å½•: </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">dir</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`ğŸ“„ Pages ç›®å½•: </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">pagesDir</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// æ‰«æè·¯ç”±</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">scanRoutes</span><span class="p">();</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`âœ… å‘ç° </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">routes</span><span class="p">.</span><span class="nx">size</span><span class="si">}</span><span class="sb"> ä¸ªé™æ€è·¯ç”±`</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`âœ… å‘ç° </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">dynamicRoutes</span><span class="p">.</span><span class="nx">size</span><span class="si">}</span><span class="sb"> ä¸ªåŠ¨æ€è·¯ç”±`</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// åˆ›å»º HTTP æœåŠ¡å™¨</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">handleRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Request error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">sendError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="c1">// ç›‘å¬ç«¯å£</span>
<span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`\nâœ¨ æœåŠ¡å™¨è¿è¡Œåœ¨ http://</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">hostname</span><span class="si">}</span><span class="sb">:</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="sb">\n`</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>å…³é”®ç‚¹</strong>ï¼š
- å¯åŠ¨å‰æ‰«æè·¯ç”±
- åˆ›å»º HTTP æœåŠ¡å™¨ï¼Œç»‘å®šè¯·æ±‚å¤„ç†å‡½æ•°
- é”™è¯¯å¤„ç†ï¼šæ•è·å¼‚æ­¥é”™è¯¯</p>
<h3>æ­¥éª¤ 3ï¼šå®ç°è¯·æ±‚å¤„ç†å…¥å£</h3>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="nx">handleRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="sb">`http://</span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">pathname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// å¤„ç†é™æ€èµ„æº</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/_next/static&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">pathname</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/static&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">serveStatic</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// å¤„ç† API è·¯ç”±</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">handleApiRoute</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// å¤„ç†é¡µé¢è·¯ç”±</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">handlePageRoute</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">,</span><span class="w"> </span><span class="nx">url</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>è·¯ç”±ä¼˜å…ˆçº§</strong>ï¼š
1. é™æ€èµ„æºï¼ˆ<code>/static/*</code>ï¼‰
2. API è·¯ç”±ï¼ˆ<code>/api/*</code>ï¼‰
3. é¡µé¢è·¯ç”±ï¼ˆå…¶ä»–è·¯å¾„ï¼‰</p>
<p><strong>è®¾è®¡è¯´æ˜</strong>ï¼š
- ä½¿ç”¨ <code>URL</code> API è§£æè¯·æ±‚ URL
- åˆ†ç¦»ä¸åŒç±»å‹çš„è¯·æ±‚å¤„ç†
- æ¸…æ™°çš„ä¼˜å…ˆçº§é¡ºåº</p>
<h3>æ­¥éª¤ 4ï¼šå®ç°é¡µé¢è·¯ç”±å¤„ç†</h3>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="nx">handlePageRoute</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">,</span><span class="w"> </span><span class="nx">url</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// åŒ¹é…è·¯ç”±</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">route</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">matchRoute</span><span class="p">(</span><span class="nx">pathname</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">route</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">send404</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// åŠ è½½é¡µé¢ç»„ä»¶</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">Component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">moduleLoader</span><span class="p">.</span><span class="nx">loadModule</span><span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">filePath</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å‡†å¤‡ propsï¼ˆåŒ…å«æŸ¥è¯¢å‚æ•°å’ŒåŠ¨æ€è·¯ç”±å‚æ•°ï¼‰</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">props</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">...</span><span class="nx">route</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span>
<span class="w">      </span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">fromEntries</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">),</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// æ¸²æŸ“é¡µé¢</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">html</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">renderFullPage</span><span class="p">(</span><span class="nx">Component</span><span class="p">,</span><span class="w"> </span><span class="nx">props</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// å‘é€å“åº”</span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mf">200</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/html; charset=utf-8&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Error rendering </span><span class="si">${</span><span class="nx">pathname</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">sendError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>å¤„ç†æµç¨‹</strong>ï¼š
1. <strong>è·¯ç”±åŒ¹é…</strong>ï¼šä½¿ç”¨è·¯ç”±ç³»ç»ŸåŒ¹é… URL
2. <strong>ç»„ä»¶åŠ è½½</strong>ï¼šåŠ¨æ€åŠ è½½é¡µé¢ç»„ä»¶
3. <strong>Props å‡†å¤‡</strong>ï¼šåˆå¹¶åŠ¨æ€å‚æ•°å’ŒæŸ¥è¯¢å‚æ•°
4. <strong>æ¸²æŸ“</strong>ï¼šæœåŠ¡ç«¯æ¸²æŸ“ç»„ä»¶ä¸º HTML
5. <strong>å“åº”</strong>ï¼šè¿”å› HTML å“åº”</p>
<p><strong>å…³é”®ç‚¹</strong>ï¼š
- å¼‚æ­¥å¤„ç†ï¼ˆ<code>async/await</code>ï¼‰
- é”™è¯¯å¤„ç†
- è®¾ç½®æ­£ç¡®çš„ Content-Type</p>
<h3>æ­¥éª¤ 5ï¼šå®ç° API è·¯ç”±å¤„ç†</h3>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="nx">handleApiRoute</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// å°† /api/xxx è½¬æ¢ä¸º pages/api/xxx.js</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathname</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// å°è¯•ä¸åŒçš„æ–‡ä»¶æ‰©å±•å</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">extensions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;.js&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;.jsx&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;.ts&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;.tsx&#39;</span><span class="p">];</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">apiFilePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">ext</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">extensions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pagesDir</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;api&#39;</span><span class="p">,</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">apiPath</span><span class="si">}${</span><span class="nx">ext</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">apiFilePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filePath</span><span class="p">;</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">apiFilePath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">send404</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">moduleLoader</span><span class="p">.</span><span class="nx">loadModule</span><span class="p">(</span><span class="nx">apiFilePath</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ‰§è¡Œ API å¤„ç†å‡½æ•°</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">handlerFn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">handler</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">handler</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">handler</span><span class="p">.</span><span class="k">default</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">handlerFn</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;API route must export a default function&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">handlerFn</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">headersSent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mf">200</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Error handling API </span><span class="si">${</span><span class="nx">pathname</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">headersSent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">sendError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>å¤„ç†æµç¨‹</strong>ï¼š
1. <strong>è·¯å¾„è½¬æ¢</strong>ï¼š<code>/api/hello</code> â†’ <code>pages/api/hello.js</code>
2. <strong>æ–‡ä»¶æŸ¥æ‰¾</strong>ï¼šå°è¯•å¤šç§æ‰©å±•å
3. <strong>åŠ è½½å¤„ç†å‡½æ•°</strong>ï¼šåŠ¨æ€å¯¼å…¥ API æ¨¡å—
4. <strong>æ‰§è¡Œå¤„ç†</strong>ï¼šè°ƒç”¨å¤„ç†å‡½æ•°
5. <strong>è¿”å›å“åº”</strong>ï¼šJSON æ ¼å¼</p>
<p><strong>å…³é”®ç‚¹</strong>ï¼š
- æ”¯æŒå¤šç§æ–‡ä»¶æ‰©å±•å
- æ£€æŸ¥å“åº”æ˜¯å¦å·²å‘é€
- é”™è¯¯å¤„ç†</p>
<h3>æ­¥éª¤ 6ï¼šå®ç°é™æ€èµ„æºæœåŠ¡</h3>
<div class="highlight"><pre><span></span><code><span class="nx">serveStatic</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ç®€åŒ–ç‰ˆï¼šåªå¤„ç† public ç›®å½•</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">publicDir</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;/static/&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">));</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">send404</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getContentType</span><span class="p">(</span><span class="nx">ext</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mf">200</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">contentType</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">getContentType</span><span class="p">(</span><span class="nx">ext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;.html&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/html&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;.css&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/css&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;.js&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/javascript&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;.json&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;.png&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;image/png&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;.jpg&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;image/jpeg&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;.gif&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;image/gif&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;.svg&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;image/svg+xml&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">types</span><span class="p">[</span><span class="nx">ext</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/octet-stream&#39;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>åŠŸèƒ½</strong>ï¼š
- ä» <code>public</code> ç›®å½•è¯»å–æ–‡ä»¶
- æ ¹æ®æ–‡ä»¶æ‰©å±•åè®¾ç½® Content-Type
- åŒæ­¥è¯»å–æ–‡ä»¶ï¼ˆç®€åŒ–å®ç°ï¼‰</p>
<h3>æ­¥éª¤ 7ï¼šå®ç°é”™è¯¯å¤„ç†</h3>
<div class="highlight"><pre><span></span><code><span class="nx">send404</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mf">404</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/html; charset=utf-8&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">    &lt;!DOCTYPE html&gt;</span>
<span class="sb">    &lt;html&gt;</span>
<span class="sb">    &lt;head&gt;&lt;title&gt;404 - Page Not Found&lt;/title&gt;&lt;/head&gt;</span>
<span class="sb">    &lt;body&gt;</span>
<span class="sb">      &lt;h1&gt;404 - Page Not Found&lt;/h1&gt;</span>
<span class="sb">      &lt;p&gt;æ— æ³•æ‰¾åˆ°é¡µé¢: </span><span class="si">${</span><span class="nx">pathname</span><span class="si">}</span><span class="sb">&lt;/p&gt;</span>
<span class="sb">    &lt;/body&gt;</span>
<span class="sb">    &lt;/html&gt;</span>
<span class="sb">  `</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">sendError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">statusCode</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">statusCode</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/html; charset=utf-8&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">    &lt;!DOCTYPE html&gt;</span>
<span class="sb">    &lt;html&gt;</span>
<span class="sb">    &lt;head&gt;&lt;title&gt;Error </span><span class="si">${</span><span class="nx">statusCode</span><span class="si">}</span><span class="sb">&lt;/title&gt;&lt;/head&gt;</span>
<span class="sb">    &lt;body&gt;</span>
<span class="sb">      &lt;h1&gt;Error </span><span class="si">${</span><span class="nx">statusCode</span><span class="si">}</span><span class="sb">&lt;/h1&gt;</span>
<span class="sb">      &lt;pre&gt;</span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">&lt;/pre&gt;</span>
<span class="sb">    &lt;/body&gt;</span>
<span class="sb">    &lt;/html&gt;</span>
<span class="sb">  `</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>è®¾è®¡è¯´æ˜</strong>ï¼š
- è¿”å›å‹å¥½çš„é”™è¯¯é¡µé¢
- æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
- è®¾ç½®æ­£ç¡®çš„çŠ¶æ€ç </p>
<h2>å®Œæ•´å®ç°</h2>
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;http&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;fs&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;path&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">FileSystemRouter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../router/file-system-router.js&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ModuleLoader</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../utils/module-loader.js&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">renderFullPage</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../renderer/ssr-renderer.js&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">DevServer</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">dir</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">port</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">3000</span><span class="p">;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">hostname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">hostname</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;localhost&#39;</span><span class="p">;</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">pagesDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dir</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pages&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">publicDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dir</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;public&#39;</span><span class="p">);</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FileSystemRouter</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pagesDir</span><span class="p">);</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">moduleLoader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ModuleLoader</span><span class="p">();</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨...`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`ğŸ“ é¡¹ç›®ç›®å½•: </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">dir</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`ğŸ“„ Pages ç›®å½•: </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">pagesDir</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">scanRoutes</span><span class="p">();</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`âœ… å‘ç° </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">routes</span><span class="p">.</span><span class="nx">size</span><span class="si">}</span><span class="sb"> ä¸ªé™æ€è·¯ç”±`</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`âœ… å‘ç° </span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">dynamicRoutes</span><span class="p">.</span><span class="nx">size</span><span class="si">}</span><span class="sb"> ä¸ªåŠ¨æ€è·¯ç”±`</span><span class="p">);</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">handleRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Request error:&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">);</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">sendError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`\nâœ¨ æœåŠ¡å™¨è¿è¡Œåœ¨ http://</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">hostname</span><span class="si">}</span><span class="sb">:</span><span class="si">${</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="sb">\n`</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">handleRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="sb">`http://</span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">host</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">pathname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/_next/static&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">pathname</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/static&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">serveStatic</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">pathname</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">handleApiRoute</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">handlePageRoute</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">,</span><span class="w"> </span><span class="nx">url</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">handlePageRoute</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">,</span><span class="w"> </span><span class="nx">url</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">route</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">matchRoute</span><span class="p">(</span><span class="nx">pathname</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">route</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">send404</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">Component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">moduleLoader</span><span class="p">.</span><span class="nx">loadModule</span><span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">filePath</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">props</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">...</span><span class="nx">route</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span>
<span class="w">        </span><span class="nx">query</span><span class="o">:</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">fromEntries</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">searchParams</span><span class="p">),</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">html</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">renderFullPage</span><span class="p">(</span><span class="nx">Component</span><span class="p">,</span><span class="w"> </span><span class="nx">props</span><span class="p">);</span>

<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mf">200</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/html; charset=utf-8&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Error rendering </span><span class="si">${</span><span class="nx">pathname</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">sendError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">handleApiRoute</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">apiPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pathname</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">extensions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;.js&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;.jsx&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;.ts&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;.tsx&#39;</span><span class="p">];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">apiFilePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">ext</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">extensions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pagesDir</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;api&#39;</span><span class="p">,</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">apiPath</span><span class="si">}${</span><span class="nx">ext</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">apiFilePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">filePath</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">apiFilePath</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">send404</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">moduleLoader</span><span class="p">.</span><span class="nx">loadModule</span><span class="p">(</span><span class="nx">apiFilePath</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">handlerFn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">handler</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">handler</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">handler</span><span class="p">.</span><span class="k">default</span><span class="p">;</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">handlerFn</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;function&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;API route must export a default function&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">handlerFn</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">);</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">headersSent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mf">200</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}));</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Error handling API </span><span class="si">${</span><span class="nx">pathname</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">res</span><span class="p">.</span><span class="nx">headersSent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">sendError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="mf">500</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">serveStatic</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">publicDir</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;/static/&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">send404</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">contentType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getContentType</span><span class="p">(</span><span class="nx">ext</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>

<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mf">200</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">contentType</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getContentType</span><span class="p">(</span><span class="nx">ext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;.html&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/html&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;.css&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/css&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;.js&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/javascript&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;.json&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;.png&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;image/png&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;.jpg&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;image/jpeg&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;.gif&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;image/gif&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;.svg&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;image/svg+xml&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">types</span><span class="p">[</span><span class="nx">ext</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;application/octet-stream&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">send404</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">pathname</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mf">404</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/html; charset=utf-8&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">      &lt;!DOCTYPE html&gt;</span>
<span class="sb">      &lt;html&gt;</span>
<span class="sb">      &lt;head&gt;&lt;title&gt;404 - Page Not Found&lt;/title&gt;&lt;/head&gt;</span>
<span class="sb">      &lt;body&gt;</span>
<span class="sb">        &lt;h1&gt;404 - Page Not Found&lt;/h1&gt;</span>
<span class="sb">        &lt;p&gt;æ— æ³•æ‰¾åˆ°é¡µé¢: </span><span class="si">${</span><span class="nx">pathname</span><span class="si">}</span><span class="sb">&lt;/p&gt;</span>
<span class="sb">      &lt;/body&gt;</span>
<span class="sb">      &lt;/html&gt;</span>
<span class="sb">    `</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">sendError</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">statusCode</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="nx">statusCode</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/html; charset=utf-8&#39;</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">      &lt;!DOCTYPE html&gt;</span>
<span class="sb">      &lt;html&gt;</span>
<span class="sb">      &lt;head&gt;&lt;title&gt;Error </span><span class="si">${</span><span class="nx">statusCode</span><span class="si">}</span><span class="sb">&lt;/title&gt;&lt;/head&gt;</span>
<span class="sb">      &lt;body&gt;</span>
<span class="sb">        &lt;h1&gt;Error </span><span class="si">${</span><span class="nx">statusCode</span><span class="si">}</span><span class="sb">&lt;/h1&gt;</span>
<span class="sb">        &lt;pre&gt;</span><span class="si">${</span><span class="nx">message</span><span class="si">}</span><span class="sb">&lt;/pre&gt;</span>
<span class="sb">      &lt;/body&gt;</span>
<span class="sb">      &lt;/html&gt;</span>
<span class="sb">    `</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">stop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">server</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2>æ€»ç»“</h2>
<p>å¼€å‘æœåŠ¡å™¨çš„æ ¸å¿ƒæ˜¯<strong>è¯·æ±‚è·¯ç”±å’Œå“åº”ç”Ÿæˆ</strong>ï¼š</p>
<ol>
<li><strong>HTTP æœåŠ¡å™¨</strong>ï¼šä½¿ç”¨ Node.js åŸç”Ÿæ¨¡å—</li>
<li><strong>è¯·æ±‚å¤„ç†</strong>ï¼šæ ¹æ®è·¯å¾„ç±»å‹åˆ†å‘åˆ°ä¸åŒå¤„ç†å™¨</li>
<li><strong>è·¯ç”±åŒ¹é…</strong>ï¼šä½¿ç”¨è·¯ç”±ç³»ç»ŸåŒ¹é…é¡µé¢</li>
<li><strong>ç»„ä»¶åŠ è½½</strong>ï¼šåŠ¨æ€åŠ è½½ React ç»„ä»¶</li>
<li><strong>HTML æ¸²æŸ“</strong>ï¼šæœåŠ¡ç«¯æ¸²æŸ“ç»„ä»¶ï¼ˆä¸‹ä¸€ç¯‡æ–‡ç« è¯¦è¿°ï¼‰</li>
</ol>
<p>åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥å®ç°<strong>æœåŠ¡ç«¯æ¸²æŸ“ç³»ç»Ÿ</strong>ï¼Œè¿™æ˜¯ Next.js çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚</p>
<hr />
<p><strong>ç›¸å…³æ–‡ä»¶</strong>ï¼š
- <code>src/server/dev-server.js</code> - å®Œæ•´å®ç°
- <code>src/cli/dev.js</code> - CLI å…¥å£</p>
        </article>
        
        <script src="https://giscus.app/client.js"
                data-repo="oasis-cloud/blog-comments"
                data-repo-id="R_kgDOKEliHA"
                data-category="General"
                data-category-id="DIC_kwDOKEliHM4CYb6e"
                data-mapping="pathname"
                data-strict="0"
                data-reactions-enabled="1"
                data-emit-metadata="0"
                data-input-position="bottom"
                data-theme="preferred_color_scheme"
                data-lang="zh-CN"
                crossorigin="anonymous"
                async>
        </script>
    </body>
</html>
