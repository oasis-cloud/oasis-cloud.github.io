<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>为什么用 ?? 而不是 ||？空值合并运算符详解</title>
        <link rel="stylesheet" href="../../assets/fonts.css">
        <link rel="stylesheet" href="../../assets/graphite.css">
        <link rel="stylesheet" href="../../assets/pygments.css">
        <script src="../../assets/image-zoom.js" defer></script>
        
        
    </head>
    <body class="node-articles-frontend-24 node-articles-frontend node-articles node">
        <header class="masthead">
            <h1><a href="../../index.html">Oasis's Cloud</a></h1>
            
                <p class="tagline">一个人的首要责任，就是要有雄心。雄心是一种高尚的激情，它可以采取多种合理的形式。<br />—— 《一个数学家的辩白》</p>
            
            
            <nav class="menu">
                <input id="menu-check" type="checkbox"/>
                <label id="menu-label" for="menu-check" class="unselectable">
                    <span class="icon close-icon">✕</span>
                    <span class="icon open-icon">☰</span>
                    <span class="text">Menu</span>
                </label>
                <ul>
<li><a href="../../index.html">首页</a></li>
</ul>
            </nav>
        </header>
        <article class="main">
            <header class="title">
                <h1>为什么用 ?? 而不是 ||？空值合并运算符详解</h1>
                
                
                    <p class="author">作者：oasis</p>
                
                <hr>
            </header>
            <p>JS 除了支持可选链运算符<code>?.</code>外，还提供空值合并运算符<code>??</code>。通过使用可选链和空值合并运算符可以大幅简化判断条件的书写方式。</p>
<p>例如
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;oasis-cloud&#39;</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="nx">user</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">country</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">country</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;China&#39;</span><span class="w"> </span>
</code></pre></div></p>
<p>例子中的条件判断需要多写一些代码。通过可选链和空值合并运算符，可以简化写法。</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;oasis-cloud&#39;</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="o">?</span><span class="p">.</span><span class="nx">country</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;China&#39;</span><span class="w"> </span>
</code></pre></div>
<p>空值合并运算符表达的意思是: 变量不是 null 和 undefined 就返回变量自身，否则返回备选值。</p>
<h2>?? 与 || 的区别</h2>
<p>空值合并运算符 <code>??</code> 与逻辑或运算符 <code>||</code> 的区别在于，<code>||</code> 会把所有假值（false、0、&rsquo;&lsquo;、null、undefined、NaN）都视为&rdquo;空&rdquo;，而 <code>??</code> 只把 null 和 undefined 视为&rdquo;空&rdquo;。</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="p">);</span><span class="w">  </span><span class="c1">// &#39;default&#39; (0 被当作假值)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="p">);</span><span class="w">  </span><span class="c1">// 0 (0 不是 null/undefined)</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">empty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">empty</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="p">);</span><span class="w">  </span><span class="c1">// &#39;default&#39;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">empty</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="p">);</span><span class="w">  </span><span class="c1">// &#39;&#39;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">falsy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">falsy</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="p">);</span><span class="w">  </span><span class="c1">// &#39;default&#39;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">falsy</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="p">);</span><span class="w">  </span><span class="c1">// false</span>
</code></pre></div>
<p>当需要区分&rdquo;空值&rdquo;（null/undefined）和&rdquo;假值&rdquo;（0、&rsquo;&lsquo;、false）时，应该使用 <code>??</code>。</p>
<h2>运算符优先级</h2>
<p><code>??</code> 不能直接与 <code>||</code> 或 <code>&amp;&amp;</code> 一起使用，会报语法错误。必须用括号明确优先级。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 错误：Uncaught SyntaxError: Unexpected token &#39;||&#39;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">c</span><span class="p">;</span>

<span class="c1">// 正确</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">result1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">a</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="nx">b</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">c</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">result2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="nx">c</span><span class="p">);</span>
</code></pre></div>
<h2>短路求值</h2>
<p><code>??</code> 是短路运算符，当左侧不是 null 或 undefined 时，不会计算右侧表达式。</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">getDefault</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;getDefault called&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;hello&#39;</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="nx">getDefault</span><span class="p">());</span><span class="w">  </span><span class="c1">// &#39;hello&#39;，不会调用 getDefault</span>
</code></pre></div>
<h2>void 0 的原因</h2>
<p>可以通过 babel 来看编译后的代码：
<a href="https://babeljs.io/repl#?config_lz=N4IgZglgNgpgdgQwLYxALhAJxgBygOgCsBnADxABoQdtiYAXY9AbWZHgDdLR6FMBzBkwwATGGAQBXKIwoACOAHt6ciDDkBGDfKUq1AfSSKARpo2UQRkdJjCJUOlWOT-kUrfT1MkmAF8AuhRs2AgAxvTcWJJw9BAo6CBS9IpICLGhIAFBIMS8ggC0AEyRYqGKmGnlxABqMJjEEIpwCYUADIUAzPlaFjgQODBQEHAwAAqYijiKxAhQCQAWYQDWmf6BOYqSmKEwACoAngMJVjaZQA&amp;code_lz=MYewdgzgLgBArhApgJxgXhgbwFAzzMAQwFtEAuGAchEIgEsIBaYAGxDgBNLsBfbbOgDMAFAhQB-AHRFSASiy58oSCBaJJbAOaikyaSUSze2ZdBig4YKMgCe6eLqkWrtmOPFUAwgAs6RSjDYQA&amp;lineWrap=true&amp;version=7.28.5">online-code</a>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">_user$country</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;oasis-cloud&#39;</span>
<span class="p">};</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">user</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">_user$country</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">country</span><span class="p">)</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">_user$country</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">_user$country</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;China&#39;</span><span class="p">;</span>
</code></pre></div></p>
<p>在查看 babel 编译后的代码，可以发现，null 采用了字面值，为什么 undefined 要通过 void 0 来获取呢？</p>
<p>在 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Lexical_grammar#%E5%85%B3%E9%94%AE%E5%AD%97">MDN</a>文档中，可以看到 null 属于关键字。</p>
<p>而 undefined 属于全局变量，可能会被污染，导致无法获取正确的 undefined。 void 关键字是对表达式求值后返回真正的 undefined，所以更安全。</p>
        </article>
        
        <script src="https://giscus.app/client.js"
                data-repo="oasis-cloud/blog-comments"
                data-repo-id="R_kgDOKEliHA"
                data-category="General"
                data-category-id="DIC_kwDOKEliHM4CYb6e"
                data-mapping="pathname"
                data-strict="0"
                data-reactions-enabled="1"
                data-emit-metadata="0"
                data-input-position="bottom"
                data-theme="preferred_color_scheme"
                data-lang="zh-CN"
                crossorigin="anonymous"
                async>
        </script>
    </body>
</html>
