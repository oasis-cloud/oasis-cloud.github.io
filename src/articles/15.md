---
title: 在 Github Action 中获取改动文件 
tags: [Programming Design]
---

在 Github Action 中获取改动的文件，主要有两种方式：

1. 通过 git 对比分支
2. 通过使用 github 提供的 API 获取文件

这里主要介绍下第二种方法。

首先我们要知道 github 有没有提供相关的 API 来查询改动的文件，其次我们从哪里获取 API 所需的参数。

github 提供了 `/repos/{owner}/{repo}/pulls/{pull_number}/files` 的 API 来查询相关内容，更多介绍可以查看[相关文档](https://docs.github.com/zh/rest/pulls/pulls?apiVersion=2022-11-28#list-pull-requests-files)。

通过调用上面的 API, 可以获取 PR 中的文件，我们需要提供 owner 和 repo 信息，以及 PR 的 ID。

PR 的 ID 可以通过 `github.event.number` 来获取，owner 和 repo 可以通过 `github.repository` 来获取。先看一下怎样获取`github.event.number`。

```yml
name: CI

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Get PR info
        run: |
          echo "PR Message github.event.number: ${{ github.event.number }}"
```

通过创建 PR ，可以在 github actions 中看到 上面脚本的输出。

[github.event.number](https://docs.github.com/zh/actions/learn-github-actions/contexts#github-context) 这种写法来自哪里？

github 来自 github action 中的[上下文概念](https://docs.github.com/zh/actions/learn-github-actions/contexts#github-context)
event 中的字段来自[Webhook 的共有属性](https://docs.github.com/zh/webhooks-and-events/webhooks/webhook-events-and-payloads#pull_request)

现在已经知道怎样获取 PR 的 ID，接下来要通过 github 的 API 来获取提交的文件路径。关键的代码如下：

```yml
pr_number=${{ github.event.number }}
files_url="https://api.github.com/repos/${{ github.repository }}/pulls/$pr_number/files"
files_response=$(curl -sSL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" $files_url)
files_changed=$(echo "$files_response" | jq -r '.[].filename')
echo "PR files: $files_changed"
```

下面逐行对上面的代码进行说明

`pr_number=${{ github.event.number }}` : 声明一个名字为 pr_number 的变量，值是 PR 的 ID。

`files_url="https://api.github.com/repos/${{ github.repository }}/pulls/$pr_number/files"` 声明 files_url 变量，github.repository 是仓库的名字。这里有个问题，什么时候需要使用 ${{ xxx }} 什么时候使用 $xxx 呢？

`files_response=$(curl -sSL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" $files_url)` 通过 curl 获取返回的结果，存放在 files_response 变量里面。

`files_changed=$(echo "$files_response" | jq -r '.[].filename')` 通过管道将 github API 返回的结果交给 jq 来处理。
[jq](https://www.tutorialspoint.com/guide-to-linux-jq-command-for-json-processing) 是什么？jq 是 linux 中的一款处理 JSON 的命令行工具，通过 jq 可以轻松提取、操作和转换 JSON 数据。 

curl 的结果可以参考 github api 提供的例子：

```shell
[
  {
    "sha": "bbcd538c8e72b8c175046e27cc8f907076331401",
    "filename": "file1.txt",
    "status": "added",
    "additions": 103,
    "deletions": 21,
    "changes": 124,
    "blob_url": "https://github.com/octocat/Hello-World/blob/6dcb09b5b57875f334f61aebed695e2e4193db5e/file1.txt",
    "raw_url": "https://github.com/octocat/Hello-World/raw/6dcb09b5b57875f334f61aebed695e2e4193db5e/file1.txt",
    "contents_url": "https://api.github.com/repos/octocat/Hello-World/contents/file1.txt?ref=6dcb09b5b57875f334f61aebed695e2e4193db5e",
    "patch": "@@ -132,7 +132,7 @@ module Test @@ -1000,7 +1000,7 @@ module Test"
  }
]
```

`jq -r '.[].filename'` 是通过递归的方式取出 filename 字段。所以这里的结果是 file1.txt

获取到文件列表之后，要对文件列表进行提取操作：

```shell
component=$(echo "$files_changed" |  grep -E -i 'src\/packages\/([a-z]+)(\/[a-z_\.]*)*' | sed -E 's/src\/packages\/([a-z]+)(\/[a-z_\.]*)*/\1/i' | awk 'END{print}')
npm test -- $component
```

在这段代码中，先通过 grep 对符合特征的文件进行提取，之后通过 sed 来提取出 packages 后面的内容。最后通过 awk 取出最后一个结果。






