---
title: "[mini-next.js] å¼€å‘æœåŠ¡å™¨ï¼šHTTP æœåŠ¡å™¨å’Œè¯·æ±‚å¤„ç†"
author: oasis
---

## æ¦‚è¿°

å¼€å‘æœåŠ¡å™¨æ˜¯ Next.js çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒè´Ÿè´£å¯åŠ¨ HTTP æœåŠ¡å™¨ã€å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ã€åŒ¹é…è·¯ç”±å¹¶æ¸²æŸ“é¡µé¢ã€‚æœ¬æ–‡å°†æ·±å…¥åˆ†æå¹¶å®ç°å¼€å‘æœåŠ¡å™¨çš„æ ¸å¿ƒåŠŸèƒ½ã€‚

## æ ¸å¿ƒåŠŸèƒ½åˆ†æ

### 1. HTTP æœåŠ¡å™¨

**èŒè´£**ï¼š
- å¯åŠ¨ HTTP æœåŠ¡å™¨
- ç›‘å¬æŒ‡å®šç«¯å£
- å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚

**æŠ€æœ¯é€‰æ‹©**ï¼š
- ä½¿ç”¨ Node.js åŸç”Ÿ `http` æ¨¡å—
- ç®€å•ã€è½»é‡ï¼Œæ— éœ€é¢å¤–ä¾èµ–

### 2. è¯·æ±‚å¤„ç†æµç¨‹

```
HTTP è¯·æ±‚
    â†“
è§£æ URL
    â†“
è·¯ç”±åŒ¹é…
    â†“
åŠ è½½ç»„ä»¶
    â†“
æ¸²æŸ“ HTML
    â†“
è¿”å›å“åº”
```

### 3. è·¯ç”±å¤„ç†

**èŒè´£**ï¼š
- æ ¹æ® URL è·¯å¾„åŒ¹é…è·¯ç”±
- å¤„ç†é™æ€è·¯ç”±å’ŒåŠ¨æ€è·¯ç”±
- æå–æŸ¥è¯¢å‚æ•°å’ŒåŠ¨æ€å‚æ•°

### 4. é™æ€èµ„æºæœåŠ¡

**èŒè´£**ï¼š
- æœåŠ¡ `public` ç›®å½•ä¸‹çš„é™æ€æ–‡ä»¶
- è®¾ç½®æ­£ç¡®çš„ Content-Type
- å¤„ç† 404 æƒ…å†µ

### 5. API è·¯ç”±å¤„ç†

**èŒè´£**ï¼š
- å¤„ç† `/api/*` è·¯å¾„
- æ‰§è¡Œ API å¤„ç†å‡½æ•°
- è¿”å› JSON å“åº”

## é€æ­¥å®ç°

### æ­¥éª¤ 1ï¼šåˆ›å»ºæœåŠ¡å™¨ç±»ç»“æ„

```javascript
import http from 'http';
import fs from 'fs';
import path from 'path';
import { FileSystemRouter } from '../router/file-system-router.js';
import { ModuleLoader } from '../utils/module-loader.js';
import { renderFullPage } from '../renderer/ssr-renderer.js';

export class DevServer {
  constructor(options = {}) {
    this.dir = options.dir || process.cwd();
    this.port = options.port || 3000;
    this.hostname = options.hostname || 'localhost';
    
    this.pagesDir = path.join(this.dir, 'pages');
    this.publicDir = path.join(this.dir, 'public');
    
    this.router = new FileSystemRouter(this.pagesDir);
    this.moduleLoader = new ModuleLoader();
    
    this.server = null;
  }
}
```

**è®¾è®¡è¯´æ˜**ï¼š
- æ¥å—é…ç½®é€‰é¡¹ï¼ˆç›®å½•ã€ç«¯å£ã€ä¸»æœºåï¼‰
- åˆå§‹åŒ–è·¯ç”±ç³»ç»Ÿå’Œæ¨¡å—åŠ è½½å™¨
- å‡†å¤‡ç›®å½•è·¯å¾„

### æ­¥éª¤ 2ï¼šå®ç°æœåŠ¡å™¨å¯åŠ¨

```javascript
async start() {
  console.log(`ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨...`);
  console.log(`ğŸ“ é¡¹ç›®ç›®å½•: ${this.dir}`);
  console.log(`ğŸ“„ Pages ç›®å½•: ${this.pagesDir}`);
  
  // æ‰«æè·¯ç”±
  this.router.scanRoutes();
  console.log(`âœ… å‘ç° ${this.router.routes.size} ä¸ªé™æ€è·¯ç”±`);
  console.log(`âœ… å‘ç° ${this.router.dynamicRoutes.size} ä¸ªåŠ¨æ€è·¯ç”±`);
  
  // åˆ›å»º HTTP æœåŠ¡å™¨
  this.server = http.createServer((req, res) => {
    this.handleRequest(req, res).catch(err => {
      console.error('Request error:', err);
      this.sendError(res, 500, err.message);
    });
  });

  // ç›‘å¬ç«¯å£
  this.server.listen(this.port, this.hostname, () => {
    console.log(`\nâœ¨ æœåŠ¡å™¨è¿è¡Œåœ¨ http://${this.hostname}:${this.port}\n`);
  });
}
```

**å…³é”®ç‚¹**ï¼š
- å¯åŠ¨å‰æ‰«æè·¯ç”±
- åˆ›å»º HTTP æœåŠ¡å™¨ï¼Œç»‘å®šè¯·æ±‚å¤„ç†å‡½æ•°
- é”™è¯¯å¤„ç†ï¼šæ•è·å¼‚æ­¥é”™è¯¯

### æ­¥éª¤ 3ï¼šå®ç°è¯·æ±‚å¤„ç†å…¥å£

```javascript
async handleRequest(req, res) {
  const url = new URL(req.url, `http://${req.headers.host}`);
  const pathname = url.pathname;

  // å¤„ç†é™æ€èµ„æº
  if (pathname.startsWith('/_next/static') || pathname.startsWith('/static')) {
    return this.serveStatic(req, res, pathname);
  }

  // å¤„ç† API è·¯ç”±
  if (pathname.startsWith('/api/')) {
    return this.handleApiRoute(req, res, pathname);
  }

  // å¤„ç†é¡µé¢è·¯ç”±
  return this.handlePageRoute(req, res, pathname, url);
}
```

**è·¯ç”±ä¼˜å…ˆçº§**ï¼š
1. é™æ€èµ„æºï¼ˆ`/static/*`ï¼‰
2. API è·¯ç”±ï¼ˆ`/api/*`ï¼‰
3. é¡µé¢è·¯ç”±ï¼ˆå…¶ä»–è·¯å¾„ï¼‰

**è®¾è®¡è¯´æ˜**ï¼š
- ä½¿ç”¨ `URL` API è§£æè¯·æ±‚ URL
- åˆ†ç¦»ä¸åŒç±»å‹çš„è¯·æ±‚å¤„ç†
- æ¸…æ™°çš„ä¼˜å…ˆçº§é¡ºåº

### æ­¥éª¤ 4ï¼šå®ç°é¡µé¢è·¯ç”±å¤„ç†

```javascript
async handlePageRoute(req, res, pathname, url) {
  // åŒ¹é…è·¯ç”±
  const route = this.router.matchRoute(pathname);
  
  if (!route) {
    return this.send404(res, pathname);
  }

  try {
    // åŠ è½½é¡µé¢ç»„ä»¶
    const Component = await this.moduleLoader.loadModule(route.filePath);
    
    // å‡†å¤‡ propsï¼ˆåŒ…å«æŸ¥è¯¢å‚æ•°å’ŒåŠ¨æ€è·¯ç”±å‚æ•°ï¼‰
    const props = {
      ...route.params,
      query: Object.fromEntries(url.searchParams),
    };

    // æ¸²æŸ“é¡µé¢
    const html = renderFullPage(Component, props);
    
    // å‘é€å“åº”
    res.writeHead(200, { 'Content-Type': 'text/html; charset=utf-8' });
    res.end(html);
  } catch (error) {
    console.error(`Error rendering ${pathname}:`, error);
    this.sendError(res, 500, error.message);
  }
}
```

**å¤„ç†æµç¨‹**ï¼š
1. **è·¯ç”±åŒ¹é…**ï¼šä½¿ç”¨è·¯ç”±ç³»ç»ŸåŒ¹é… URL
2. **ç»„ä»¶åŠ è½½**ï¼šåŠ¨æ€åŠ è½½é¡µé¢ç»„ä»¶
3. **Props å‡†å¤‡**ï¼šåˆå¹¶åŠ¨æ€å‚æ•°å’ŒæŸ¥è¯¢å‚æ•°
4. **æ¸²æŸ“**ï¼šæœåŠ¡ç«¯æ¸²æŸ“ç»„ä»¶ä¸º HTML
5. **å“åº”**ï¼šè¿”å› HTML å“åº”

**å…³é”®ç‚¹**ï¼š
- å¼‚æ­¥å¤„ç†ï¼ˆ`async/await`ï¼‰
- é”™è¯¯å¤„ç†
- è®¾ç½®æ­£ç¡®çš„ Content-Type

### æ­¥éª¤ 5ï¼šå®ç° API è·¯ç”±å¤„ç†

```javascript
async handleApiRoute(req, res, pathname) {
  // å°† /api/xxx è½¬æ¢ä¸º pages/api/xxx.js
  const apiPath = pathname.replace('/api/', '');
  
  // å°è¯•ä¸åŒçš„æ–‡ä»¶æ‰©å±•å
  const extensions = ['.js', '.jsx', '.ts', '.tsx'];
  let apiFilePath = null;
  
  for (const ext of extensions) {
    const filePath = path.join(this.pagesDir, 'api', `${apiPath}${ext}`);
    if (fs.existsSync(filePath)) {
      apiFilePath = filePath;
      break;
    }
  }
  
  if (!apiFilePath) {
    return this.send404(res, pathname);
  }

  try {
    const handler = await this.moduleLoader.loadModule(apiFilePath);
    
    // æ‰§è¡Œ API å¤„ç†å‡½æ•°
    const handlerFn = typeof handler === 'function' ? handler : handler.default;
    
    if (typeof handlerFn !== 'function') {
      throw new Error('API route must export a default function');
    }
    
    const result = await handlerFn(req, res);
    
    if (!res.headersSent) {
      res.writeHead(200, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify(result || { success: true }));
    }
  } catch (error) {
    console.error(`Error handling API ${pathname}:`, error);
    if (!res.headersSent) {
      this.sendError(res, 500, error.message);
    }
  }
}
```

**å¤„ç†æµç¨‹**ï¼š
1. **è·¯å¾„è½¬æ¢**ï¼š`/api/hello` â†’ `pages/api/hello.js`
2. **æ–‡ä»¶æŸ¥æ‰¾**ï¼šå°è¯•å¤šç§æ‰©å±•å
3. **åŠ è½½å¤„ç†å‡½æ•°**ï¼šåŠ¨æ€å¯¼å…¥ API æ¨¡å—
4. **æ‰§è¡Œå¤„ç†**ï¼šè°ƒç”¨å¤„ç†å‡½æ•°
5. **è¿”å›å“åº”**ï¼šJSON æ ¼å¼

**å…³é”®ç‚¹**ï¼š
- æ”¯æŒå¤šç§æ–‡ä»¶æ‰©å±•å
- æ£€æŸ¥å“åº”æ˜¯å¦å·²å‘é€
- é”™è¯¯å¤„ç†

### æ­¥éª¤ 6ï¼šå®ç°é™æ€èµ„æºæœåŠ¡

```javascript
serveStatic(req, res, pathname) {
  // ç®€åŒ–ç‰ˆï¼šåªå¤„ç† public ç›®å½•
  const filePath = path.join(this.publicDir, pathname.replace('/static/', ''));
  
  if (!fs.existsSync(filePath)) {
    return this.send404(res, pathname);
  }

  const ext = path.extname(filePath);
  const contentType = this.getContentType(ext);
  
  const content = fs.readFileSync(filePath);
  res.writeHead(200, { 'Content-Type': contentType });
  res.end(content);
}

getContentType(ext) {
  const types = {
    '.html': 'text/html',
    '.css': 'text/css',
    '.js': 'application/javascript',
    '.json': 'application/json',
    '.png': 'image/png',
    '.jpg': 'image/jpeg',
    '.gif': 'image/gif',
    '.svg': 'image/svg+xml',
  };
  return types[ext] || 'application/octet-stream';
}
```

**åŠŸèƒ½**ï¼š
- ä» `public` ç›®å½•è¯»å–æ–‡ä»¶
- æ ¹æ®æ–‡ä»¶æ‰©å±•åè®¾ç½® Content-Type
- åŒæ­¥è¯»å–æ–‡ä»¶ï¼ˆç®€åŒ–å®ç°ï¼‰

### æ­¥éª¤ 7ï¼šå®ç°é”™è¯¯å¤„ç†

```javascript
send404(res, pathname) {
  res.writeHead(404, { 'Content-Type': 'text/html; charset=utf-8' });
  res.end(`
    <!DOCTYPE html>
    <html>
    <head><title>404 - Page Not Found</title></head>
    <body>
      <h1>404 - Page Not Found</h1>
      <p>æ— æ³•æ‰¾åˆ°é¡µé¢: ${pathname}</p>
    </body>
    </html>
  `);
}

sendError(res, statusCode, message) {
  res.writeHead(statusCode, { 'Content-Type': 'text/html; charset=utf-8' });
  res.end(`
    <!DOCTYPE html>
    <html>
    <head><title>Error ${statusCode}</title></head>
    <body>
      <h1>Error ${statusCode}</h1>
      <pre>${message}</pre>
    </body>
    </html>
  `);
}
```

**è®¾è®¡è¯´æ˜**ï¼š
- è¿”å›å‹å¥½çš„é”™è¯¯é¡µé¢
- æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
- è®¾ç½®æ­£ç¡®çš„çŠ¶æ€ç 

## å®Œæ•´å®ç°

```javascript
import http from 'http';
import fs from 'fs';
import path from 'path';
import { FileSystemRouter } from '../router/file-system-router.js';
import { ModuleLoader } from '../utils/module-loader.js';
import { renderFullPage } from '../renderer/ssr-renderer.js';

export class DevServer {
  constructor(options = {}) {
    this.dir = options.dir || process.cwd();
    this.port = options.port || 3000;
    this.hostname = options.hostname || 'localhost';
    
    this.pagesDir = path.join(this.dir, 'pages');
    this.publicDir = path.join(this.dir, 'public');
    
    this.router = new FileSystemRouter(this.pagesDir);
    this.moduleLoader = new ModuleLoader();
    
    this.server = null;
  }

  async start() {
    console.log(`ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨...`);
    console.log(`ğŸ“ é¡¹ç›®ç›®å½•: ${this.dir}`);
    console.log(`ğŸ“„ Pages ç›®å½•: ${this.pagesDir}`);
    
    this.router.scanRoutes();
    console.log(`âœ… å‘ç° ${this.router.routes.size} ä¸ªé™æ€è·¯ç”±`);
    console.log(`âœ… å‘ç° ${this.router.dynamicRoutes.size} ä¸ªåŠ¨æ€è·¯ç”±`);
    
    this.server = http.createServer((req, res) => {
      this.handleRequest(req, res).catch(err => {
        console.error('Request error:', err);
        this.sendError(res, 500, err.message);
      });
    });

    this.server.listen(this.port, this.hostname, () => {
      console.log(`\nâœ¨ æœåŠ¡å™¨è¿è¡Œåœ¨ http://${this.hostname}:${this.port}\n`);
    });
  }

  async handleRequest(req, res) {
    const url = new URL(req.url, `http://${req.headers.host}`);
    const pathname = url.pathname;

    if (pathname.startsWith('/_next/static') || pathname.startsWith('/static')) {
      return this.serveStatic(req, res, pathname);
    }

    if (pathname.startsWith('/api/')) {
      return this.handleApiRoute(req, res, pathname);
    }

    return this.handlePageRoute(req, res, pathname, url);
  }

  async handlePageRoute(req, res, pathname, url) {
    const route = this.router.matchRoute(pathname);
    
    if (!route) {
      return this.send404(res, pathname);
    }

    try {
      const Component = await this.moduleLoader.loadModule(route.filePath);
      const props = {
        ...route.params,
        query: Object.fromEntries(url.searchParams),
      };
      const html = renderFullPage(Component, props);
      
      res.writeHead(200, { 'Content-Type': 'text/html; charset=utf-8' });
      res.end(html);
    } catch (error) {
      console.error(`Error rendering ${pathname}:`, error);
      this.sendError(res, 500, error.message);
    }
  }

  async handleApiRoute(req, res, pathname) {
    const apiPath = pathname.replace('/api/', '');
    const extensions = ['.js', '.jsx', '.ts', '.tsx'];
    let apiFilePath = null;
    
    for (const ext of extensions) {
      const filePath = path.join(this.pagesDir, 'api', `${apiPath}${ext}`);
      if (fs.existsSync(filePath)) {
        apiFilePath = filePath;
        break;
      }
    }
    
    if (!apiFilePath) {
      return this.send404(res, pathname);
    }

    try {
      const handler = await this.moduleLoader.loadModule(apiFilePath);
      const handlerFn = typeof handler === 'function' ? handler : handler.default;
      
      if (typeof handlerFn !== 'function') {
        throw new Error('API route must export a default function');
      }
      
      const result = await handlerFn(req, res);
      
      if (!res.headersSent) {
        res.writeHead(200, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify(result || { success: true }));
      }
    } catch (error) {
      console.error(`Error handling API ${pathname}:`, error);
      if (!res.headersSent) {
        this.sendError(res, 500, error.message);
      }
    }
  }

  serveStatic(req, res, pathname) {
    const filePath = path.join(this.publicDir, pathname.replace('/static/', ''));
    
    if (!fs.existsSync(filePath)) {
      return this.send404(res, pathname);
    }

    const ext = path.extname(filePath);
    const contentType = this.getContentType(ext);
    const content = fs.readFileSync(filePath);
    
    res.writeHead(200, { 'Content-Type': contentType });
    res.end(content);
  }

  getContentType(ext) {
    const types = {
      '.html': 'text/html',
      '.css': 'text/css',
      '.js': 'application/javascript',
      '.json': 'application/json',
      '.png': 'image/png',
      '.jpg': 'image/jpeg',
      '.gif': 'image/gif',
      '.svg': 'image/svg+xml',
    };
    return types[ext] || 'application/octet-stream';
  }

  send404(res, pathname) {
    res.writeHead(404, { 'Content-Type': 'text/html; charset=utf-8' });
    res.end(`
      <!DOCTYPE html>
      <html>
      <head><title>404 - Page Not Found</title></head>
      <body>
        <h1>404 - Page Not Found</h1>
        <p>æ— æ³•æ‰¾åˆ°é¡µé¢: ${pathname}</p>
      </body>
      </html>
    `);
  }

  sendError(res, statusCode, message) {
    res.writeHead(statusCode, { 'Content-Type': 'text/html; charset=utf-8' });
    res.end(`
      <!DOCTYPE html>
      <html>
      <head><title>Error ${statusCode}</title></head>
      <body>
        <h1>Error ${statusCode}</h1>
        <pre>${message}</pre>
      </body>
      </html>
    `);
  }

  stop() {
    if (this.server) {
      this.server.close();
    }
  }
}
```

## æ€»ç»“

å¼€å‘æœåŠ¡å™¨çš„æ ¸å¿ƒæ˜¯**è¯·æ±‚è·¯ç”±å’Œå“åº”ç”Ÿæˆ**ï¼š

1. **HTTP æœåŠ¡å™¨**ï¼šä½¿ç”¨ Node.js åŸç”Ÿæ¨¡å—
2. **è¯·æ±‚å¤„ç†**ï¼šæ ¹æ®è·¯å¾„ç±»å‹åˆ†å‘åˆ°ä¸åŒå¤„ç†å™¨
3. **è·¯ç”±åŒ¹é…**ï¼šä½¿ç”¨è·¯ç”±ç³»ç»ŸåŒ¹é…é¡µé¢
4. **ç»„ä»¶åŠ è½½**ï¼šåŠ¨æ€åŠ è½½ React ç»„ä»¶
5. **HTML æ¸²æŸ“**ï¼šæœåŠ¡ç«¯æ¸²æŸ“ç»„ä»¶ï¼ˆä¸‹ä¸€ç¯‡æ–‡ç« è¯¦è¿°ï¼‰

åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥å®ç°**æœåŠ¡ç«¯æ¸²æŸ“ç³»ç»Ÿ**ï¼Œè¿™æ˜¯ Next.js çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚

---

**ç›¸å…³æ–‡ä»¶**ï¼š
- `src/server/dev-server.js` - å®Œæ•´å®ç°
- `src/cli/dev.js` - CLI å…¥å£

