---
title: "[mini-next.js] çƒ­é‡è½½ï¼šå¼€å‘ä½“éªŒä¼˜åŒ–"
author: oasis
---

## æ¦‚è¿°

çƒ­é‡è½½ï¼ˆHot Reloadï¼‰æ˜¯ç°ä»£å‰ç«¯å¼€å‘å·¥å…·çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ã€‚å®ƒå…è®¸å¼€å‘è€…åœ¨ä¿®æ”¹ä»£ç åï¼Œæµè§ˆå™¨è‡ªåŠ¨åˆ·æ–°é¡µé¢ï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–°ã€‚æœ¬æ–‡å°†æ·±å…¥åˆ†æå¹¶å®ç°çƒ­é‡è½½åŠŸèƒ½ã€‚

## æ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯çƒ­é‡è½½ï¼Ÿ

**ä¼ ç»Ÿå¼€å‘æµç¨‹**ï¼š
```
1. ä¿®æ”¹ä»£ç 
2. æ‰‹åŠ¨åˆ·æ–°æµè§ˆå™¨
3. æŸ¥çœ‹æ•ˆæœ
```

**çƒ­é‡è½½æµç¨‹**ï¼š
```
1. ä¿®æ”¹ä»£ç 
2. æ–‡ä»¶ç›‘å¬å™¨æ£€æµ‹åˆ°å˜åŒ–
3. è‡ªåŠ¨é‡æ–°åŠ è½½
4. æµè§ˆå™¨è‡ªåŠ¨åˆ·æ–°ï¼ˆæˆ–é€šè¿‡ WebSocket é€šçŸ¥ï¼‰
```

### çƒ­é‡è½½çš„ä¼˜åŠ¿

1. **æé«˜å¼€å‘æ•ˆç‡**ï¼šæ— éœ€æ‰‹åŠ¨åˆ·æ–°
2. **ä¿æŒçŠ¶æ€**ï¼šæŸäº›æƒ…å†µä¸‹å¯ä»¥ä¿æŒåº”ç”¨çŠ¶æ€
3. **å³æ—¶åé¦ˆ**ï¼šç«‹å³çœ‹åˆ°ä»£ç å˜åŒ–çš„æ•ˆæœ

## åŠŸèƒ½åˆ†æ

### 1. æ–‡ä»¶ç³»ç»Ÿç›‘å¬

**èŒè´£**ï¼š
- ç›‘å¬ `pages` å’Œ `app` ç›®å½•çš„å˜åŒ–
- æ£€æµ‹æ–‡ä»¶åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤

**æŠ€æœ¯é€‰æ‹©**ï¼š
- ä½¿ç”¨ `chokidar` åº“ï¼ˆè·¨å¹³å°æ–‡ä»¶ç›‘å¬ï¼‰

### 2. æ¨¡å—ç¼“å­˜ç®¡ç†

**èŒè´£**ï¼š
- ç¼“å­˜å·²åŠ è½½çš„æ¨¡å—
- æ–‡ä»¶å˜åŒ–æ—¶æ¸…é™¤ç›¸å…³ç¼“å­˜
- é‡æ–°åŠ è½½æ¨¡å—

### 3. è·¯ç”±é‡æ–°æ‰«æ

**èŒè´£**ï¼š
- æ–‡ä»¶å˜åŒ–æ—¶é‡æ–°æ‰«æè·¯ç”±
- æ›´æ–°è·¯ç”±æ˜ å°„è¡¨

### 4. æµè§ˆå™¨é€šçŸ¥ï¼ˆç®€åŒ–ç‰ˆï¼‰

**èŒè´£**ï¼š
- é€šçŸ¥æµè§ˆå™¨åˆ·æ–°ï¼ˆç®€åŒ–å®ç°ï¼šä»…æ—¥å¿—è¾“å‡ºï¼‰
- çœŸå® Next.js ä½¿ç”¨ WebSocket

## é€æ­¥å®ç°

### æ­¥éª¤ 1ï¼šå®ç°æ¨¡å—åŠ è½½å™¨

```javascript
// src/utils/module-loader.js

export class ModuleLoader {
  constructor() {
    this.cache = new Map();
    this.watchFiles = new Set();
  }

  async loadModule(filePath) {
    // æ£€æŸ¥ç¼“å­˜
    if (this.cache.has(filePath)) {
      return this.cache.get(filePath);
    }

    // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if (!fs.existsSync(filePath)) {
      throw new Error(`Module not found: ${filePath}`);
    }

    try {
      // åŠ¨æ€å¯¼å…¥æ¨¡å—
      const module = await import(`file://${filePath}`);
      
      // è·å–é»˜è®¤å¯¼å‡ºæˆ–å‘½åå¯¼å‡º
      const component = module.default || module;
      
      // ç¼“å­˜æ¨¡å—
      this.cache.set(filePath, component);
      this.watchFiles.add(filePath);
      
      return component;
    } catch (error) {
      console.error(`Error loading module ${filePath}:`, error);
      throw error;
    }
  }

  clearCache(filePath = null) {
    if (filePath) {
      this.cache.delete(filePath);
      this.watchFiles.delete(filePath);
    } else {
      this.cache.clear();
      this.watchFiles.clear();
    }
  }

  getWatchedFiles() {
    return Array.from(this.watchFiles);
  }
}
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨ `Map` ç¼“å­˜æ¨¡å—
- åŠ¨æ€å¯¼å…¥ä½¿ç”¨ `file://` åè®®
- æ”¯æŒæ¸…é™¤å•ä¸ªæˆ–å…¨éƒ¨ç¼“å­˜

### æ­¥éª¤ 2ï¼šå®ç°æ–‡ä»¶ç›‘å¬å™¨

```javascript
// src/server/dev-server.js

import chokidar from 'chokidar';

_startWatcher() {
  const watchDirs = [];
  if (this.useAppRouter && fs.existsSync(this.appDir)) {
    watchDirs.push(this.appDir);
  }
  if (this.usePagesRouter && fs.existsSync(this.pagesDir)) {
    watchDirs.push(this.pagesDir);
  }

  if (watchDirs.length === 0) {
    return;
  }

  this.watcher = chokidar.watch(watchDirs, {
    ignored: /node_modules/,
    persistent: true,
  });

  this.watcher.on('change', (filePath) => {
    console.log(`\nğŸ”„ æ–‡ä»¶å˜åŒ–: ${filePath}`);
    
    // æ¸…é™¤ç›¸å…³æ¨¡å—ç¼“å­˜
    this.moduleLoader.clearCache(filePath);
    
    // é‡æ–°æ‰«æè·¯ç”±
    if (this.useAppRouter && filePath.startsWith(this.appDir)) {
      this.appRouter.scanRoutes();
    }
    if (this.usePagesRouter && filePath.startsWith(this.pagesDir)) {
      this.pagesRouter.scanRoutes();
    }
    
    console.log(`âœ… å·²é‡æ–°åŠ è½½\n`);
  });

  this.watcher.on('add', (filePath) => {
    console.log(`\nâ• æ–°å¢æ–‡ä»¶: ${filePath}`);
    if (this.useAppRouter && filePath.startsWith(this.appDir)) {
      this.appRouter.scanRoutes();
    }
    if (this.usePagesRouter && filePath.startsWith(this.pagesDir)) {
      this.pagesRouter.scanRoutes();
    }
    console.log(`âœ… è·¯ç”±å·²æ›´æ–°\n`);
  });

  this.watcher.on('unlink', (filePath) => {
    console.log(`\nâ– åˆ é™¤æ–‡ä»¶: ${filePath}`);
    this.moduleLoader.clearCache(filePath);
    if (this.useAppRouter && filePath.startsWith(this.appDir)) {
      this.appRouter.scanRoutes();
    }
    if (this.usePagesRouter && filePath.startsWith(this.pagesDir)) {
      this.pagesRouter.scanRoutes();
    }
    console.log(`âœ… è·¯ç”±å·²æ›´æ–°\n`);
  });
}
```

**å…³é”®ç‚¹**ï¼š
- ç›‘å¬å¤šä¸ªç›®å½•ï¼ˆ`app` å’Œ `pages`ï¼‰
- å¿½ç•¥ `node_modules`
- å¤„ç†ä¸‰ç§äº‹ä»¶ï¼š`change`ã€`add`ã€`unlink`
- æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°æ‰«æè·¯ç”±

### æ­¥éª¤ 3ï¼šåœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶å¯åŠ¨ç›‘å¬

```javascript
async start() {
  // ... å…¶ä»–åˆå§‹åŒ–ä»£ç  ...
  
  // å¯åŠ¨æ–‡ä»¶ç›‘å¬
  this._startWatcher();
  
  // ... å¯åŠ¨ HTTP æœåŠ¡å™¨ ...
}
```

## å®Œæ•´å®ç°

### æ¨¡å—åŠ è½½å™¨

```javascript
// src/utils/module-loader.js

import fs from 'fs';

export class ModuleLoader {
  constructor() {
    this.cache = new Map();
    this.watchFiles = new Set();
  }

  async loadModule(filePath) {
    if (this.cache.has(filePath)) {
      return this.cache.get(filePath);
    }

    if (!fs.existsSync(filePath)) {
      throw new Error(`Module not found: ${filePath}`);
    }

    try {
      const module = await import(`file://${filePath}`);
      const component = module.default || module;
      
      this.cache.set(filePath, component);
      this.watchFiles.add(filePath);
      
      return component;
    } catch (error) {
      console.error(`Error loading module ${filePath}:`, error);
      throw error;
    }
  }

  clearCache(filePath = null) {
    if (filePath) {
      this.cache.delete(filePath);
      this.watchFiles.delete(filePath);
    } else {
      this.cache.clear();
      this.watchFiles.clear();
    }
  }

  getWatchedFiles() {
    return Array.from(this.watchFiles);
  }
}
```

### æ–‡ä»¶ç›‘å¬å™¨é›†æˆ

```javascript
// src/server/dev-server.js

import chokidar from 'chokidar';

export class DevServer {
  // ... å…¶ä»–ä»£ç  ...

  async start() {
    // ... åˆå§‹åŒ–ä»£ç  ...
    
    // å¯åŠ¨æ–‡ä»¶ç›‘å¬
    this._startWatcher();
    
    // ... å¯åŠ¨æœåŠ¡å™¨ ...
  }

  _startWatcher() {
    const watchDirs = [];
    if (this.useAppRouter && fs.existsSync(this.appDir)) {
      watchDirs.push(this.appDir);
    }
    if (this.usePagesRouter && fs.existsSync(this.pagesDir)) {
      watchDirs.push(this.pagesDir);
    }

    if (watchDirs.length === 0) {
      return;
    }

    this.watcher = chokidar.watch(watchDirs, {
      ignored: /node_modules/,
      persistent: true,
    });

    this.watcher.on('change', (filePath) => {
      console.log(`\nğŸ”„ æ–‡ä»¶å˜åŒ–: ${filePath}`);
      this.moduleLoader.clearCache(filePath);
      
      if (this.useAppRouter && filePath.startsWith(this.appDir)) {
        this.appRouter.scanRoutes();
      }
      if (this.usePagesRouter && filePath.startsWith(this.pagesDir)) {
        this.pagesRouter.scanRoutes();
      }
      
      console.log(`âœ… å·²é‡æ–°åŠ è½½\n`);
    });

    this.watcher.on('add', (filePath) => {
      console.log(`\nâ• æ–°å¢æ–‡ä»¶: ${filePath}`);
      if (this.useAppRouter && filePath.startsWith(this.appDir)) {
        this.appRouter.scanRoutes();
      }
      if (this.usePagesRouter && filePath.startsWith(this.pagesDir)) {
        this.pagesRouter.scanRoutes();
      }
      console.log(`âœ… è·¯ç”±å·²æ›´æ–°\n`);
    });

    this.watcher.on('unlink', (filePath) => {
      console.log(`\nâ– åˆ é™¤æ–‡ä»¶: ${filePath}`);
      this.moduleLoader.clearCache(filePath);
      if (this.useAppRouter && filePath.startsWith(this.appDir)) {
        this.appRouter.scanRoutes();
      }
      if (this.usePagesRouter && filePath.startsWith(this.pagesDir)) {
        this.pagesRouter.scanRoutes();
      }
      console.log(`âœ… è·¯ç”±å·²æ›´æ–°\n`);
    });
  }

  stop() {
    if (this.watcher) {
      this.watcher.close();
    }
    if (this.server) {
      this.server.close();
    }
  }
}
```

## å·¥ä½œæµç¨‹

### æ–‡ä»¶ä¿®æ”¹æµç¨‹

```
1. å¼€å‘è€…ä¿®æ”¹ pages/about.js
   â†“
2. chokidar æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–
   â†“
3. è§¦å‘ 'change' äº‹ä»¶
   â†“
4. æ¸…é™¤æ¨¡å—ç¼“å­˜ï¼ˆabout.jsï¼‰
   â†“
5. é‡æ–°æ‰«æè·¯ç”±ï¼ˆå¦‚æœæœ‰ç»“æ„å˜åŒ–ï¼‰
   â†“
6. ä¸‹æ¬¡è¯·æ±‚æ—¶é‡æ–°åŠ è½½æ¨¡å—
```

### æ–°å¢æ–‡ä»¶æµç¨‹

```
1. å¼€å‘è€…åˆ›å»º pages/new-page.js
   â†“
2. chokidar æ£€æµ‹åˆ°æ–°æ–‡ä»¶
   â†“
3. è§¦å‘ 'add' äº‹ä»¶
   â†“
4. é‡æ–°æ‰«æè·¯ç”±
   â†“
5. æ–°è·¯ç”±ç«‹å³å¯ç”¨
```

### åˆ é™¤æ–‡ä»¶æµç¨‹

```
1. å¼€å‘è€…åˆ é™¤ pages/old-page.js
   â†“
2. chokidar æ£€æµ‹åˆ°æ–‡ä»¶åˆ é™¤
   â†“
3. è§¦å‘ 'unlink' äº‹ä»¶
   â†“
4. æ¸…é™¤æ¨¡å—ç¼“å­˜
   â†“
5. é‡æ–°æ‰«æè·¯ç”±
   â†“
6. è·¯ç”±ä»æ˜ å°„è¡¨ä¸­ç§»é™¤
```

## ä¸çœŸå® Next.js çš„å·®å¼‚

### å·²å®ç°
- âœ… æ–‡ä»¶ç³»ç»Ÿç›‘å¬
- âœ… æ¨¡å—ç¼“å­˜æ¸…é™¤
- âœ… è·¯ç”±é‡æ–°æ‰«æ

### æœªå®ç°ï¼ˆç®€åŒ–ï¼‰
- âŒ **WebSocket é€šçŸ¥**ï¼šçœŸå® Next.js é€šè¿‡ WebSocket é€šçŸ¥æµè§ˆå™¨åˆ·æ–°
- âŒ **å¢é‡æ›´æ–°**ï¼šåªæ›´æ–°å˜åŒ–çš„éƒ¨åˆ†
- âŒ **çŠ¶æ€ä¿æŒ**ï¼šæŸäº›æƒ…å†µä¸‹ä¿æŒåº”ç”¨çŠ¶æ€
- âŒ **é”™è¯¯æ¢å¤**ï¼šè‡ªåŠ¨æ¢å¤ç¼–è¯‘é”™è¯¯

## ä½¿ç”¨ç¤ºä¾‹

### å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
npm run dev
```

### ä¿®æ”¹æ–‡ä»¶

```javascript
// pages/about.js
export default function About() {
  return <h1>About Page - Updated!</h1>;
}
```

**æ§åˆ¶å°è¾“å‡º**ï¼š
```
ğŸ”„ æ–‡ä»¶å˜åŒ–: /path/to/pages/about.js
âœ… å·²é‡æ–°åŠ è½½
```

### åˆ·æ–°æµè§ˆå™¨

è®¿é—®é¡µé¢æ—¶ï¼Œä¼šä½¿ç”¨æ–°åŠ è½½çš„æ¨¡å—ï¼Œæ˜¾ç¤ºæ›´æ–°åçš„å†…å®¹ã€‚

## æ€»ç»“

çƒ­é‡è½½çš„æ ¸å¿ƒæ˜¯**æ–‡ä»¶ç›‘å¬å’Œæ¨¡å—ç¼“å­˜ç®¡ç†**ï¼š

1. **æ–‡ä»¶ç›‘å¬**ï¼šä½¿ç”¨ `chokidar` ç›‘å¬æ–‡ä»¶ç³»ç»Ÿå˜åŒ–
2. **ç¼“å­˜æ¸…é™¤**ï¼šæ–‡ä»¶å˜åŒ–æ—¶æ¸…é™¤ç›¸å…³æ¨¡å—ç¼“å­˜
3. **è·¯ç”±æ›´æ–°**ï¼šé‡æ–°æ‰«æè·¯ç”±ä»¥åæ˜ æ–‡ä»¶ç»“æ„å˜åŒ–
4. **è‡ªåŠ¨é‡è½½**ï¼šä¸‹æ¬¡è¯·æ±‚æ—¶ä½¿ç”¨æ–°ä»£ç 

è¿™ä¸ªå®ç°è™½ç„¶ç®€åŒ–ï¼Œä½†åŒ…å«äº†çƒ­é‡è½½çš„æ ¸å¿ƒé€»è¾‘ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œå¼€å‘è€…ä¿®æ”¹ä»£ç åï¼ŒæœåŠ¡å™¨ä¼šè‡ªåŠ¨æ£€æµ‹å˜åŒ–å¹¶é‡æ–°åŠ è½½ï¼Œå¤§å¤§æé«˜äº†å¼€å‘æ•ˆç‡ã€‚

---

**ç›¸å…³æ–‡ä»¶**ï¼š
- `src/utils/module-loader.js` - æ¨¡å—åŠ è½½å™¨å®ç°
- `src/server/dev-server.js` - æ–‡ä»¶ç›‘å¬å™¨é›†æˆ
- `package.json` - chokidar ä¾èµ–

