<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>NutUI React CI/CD -- è‡ªåŠ¨åŒ–æµ‹è¯•</title>
        <link rel="stylesheet" href="../assets/fonts.css">
        <link rel="stylesheet" href="../assets/graphite.css">
        <link rel="stylesheet" href="../assets/pygments.css">
        
        
    </head>
    <body class="node-articles-15-1 node-articles node">
        <header class="masthead">
            <h1><a href="../index.html">Oasis's Cloud</a></h1>
            
                <p class="tagline">â˜ï¸ğŸŒµï¸â˜ï¸ğŸŒµï¸â˜ï¸ğŸŒµâ˜ï¸ğŸŒµï¸â˜ï¸ğŸŒµï¸â˜ï¸ğŸŒµâ˜ï¸ğŸŒµ</p>
            
            
            <nav class="menu">
                <input id="menu-check" type="checkbox"/>
                <label id="menu-label" for="menu-check" class="unselectable">
                    <span class="icon close-icon">âœ•</span>
                    <span class="icon open-icon">â˜°</span>
                    <span class="text">Menu</span>
                </label>
                <ul>
<li><a href="../index.html">é¦–é¡µ</a></li>
</ul>
            </nav>
        </header>
        <article class="main">
            <header class="title">
                <h1>NutUI React CI/CD -- è‡ªåŠ¨åŒ–æµ‹è¯•</h1>
                
                <hr>
            </header>
            <h2>GitHub Actions ä»‹ç»</h2>
<p>GitHub Actions æ˜¯ GitHub æä¾›çš„ä¸€é¡¹åŠŸèƒ½ï¼Œå¯ä»¥ç”¨æ¥åœ¨ GitHub ä¸Šåˆ›å»ºã€æµ‹è¯•ã€éƒ¨ç½²åº”ç”¨ç¨‹åºã€‚å®ƒæ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–å·¥ä½œæµç¨‹å¹³å°ï¼Œå¯ä»¥é€šè¿‡è§¦å‘äº‹ä»¶æ¥æ‰§è¡Œä¸€ç³»åˆ—æ“ä½œï¼Œä¾‹å¦‚è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œæ‰“åŒ…æ„å»ºç­‰ã€‚</p>
<p>GitHub Actions æœ‰å‡ ä¸ªæ ¸å¿ƒçš„æ¦‚å¿µï¼š</p>
<ol>
<li>Workflowsï¼ˆå·¥ä½œæµï¼‰ï¼šCI/CD ä»å¼€å§‹åˆ°ç»“æŸè¿™ä¸ªå‘¨æœŸå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå·¥ä½œæµã€‚å·¥ä½œæµå¯ä»¥é€šè¿‡ yml è„šæœ¬é…ç½®ï¼Œå¹¶ä¸”ä¸€ä¸ªå·¥ä½œæµå¯ä»¥åŒ…å«ä¸€ä¸ª Job æˆ– å¤šä¸ª Jobã€‚</li>
<li>Eventsï¼ˆäº‹ä»¶ï¼‰ï¼šè§¦å‘ Workflows çš„ç‰¹å®šæ“ä½œï¼Œä¾‹å¦‚ï¼šPR åˆ›å»ºï¼Œä»£ç  Push ç­‰ã€‚</li>
<li>Jobsï¼ˆä»»åŠ¡ï¼‰ï¼šä¸€ä¸ª Job ç”±ä¸€ç³»åˆ—çš„æ­¥éª¤ç»„æˆï¼Œå…¶ä¸­æ¯ä¸ªæ­¥éª¤å¯ä»¥æ ‡æ³¨æ­¥éª¤åç§°ï¼Œæ‰§è¡Œçš„è„šæœ¬ç­‰ã€‚</li>
<li>Actionsï¼ˆåŠ¨ä½œï¼‰ï¼šæ¯ä¸ªæ­¥éª¤å¯ä»¥æ‰§è¡Œçš„å¤„ç†ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªã€‚</li>
<li>Runnersï¼ˆæ‰§è¡Œå™¨ï¼‰ï¼šworkflows è¿è¡Œçš„å®¹å™¨ã€‚</li>
</ol>
<h2>åˆ›å»º GitHub Actions</h2>
<p>åœ¨ä»“åº“ä¸­åˆ›å»º <code>.github/workflows</code> æ–‡ä»¶ã€‚</p>
<p>åœ¨ <code>.github/workflows</code> ç›®å½•ä¸­ï¼Œåˆ›å»º <code>test.yml</code>ï¼Œè¿™é‡Œåªæ˜¯ä¸¾ä¾‹ï¼Œæ–‡ä»¶å¯ä»¥å®šä¹‰å…¶ä»–åå­—ã€‚</p>
<div class="highlight"><pre><span></span><code><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test</span><span class="w"></span>

<span class="nt">on</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">push</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">main</span><span class="w"></span>

<span class="nt">jobs</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span><span class="w"></span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo something</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &#39;Hello World&#39;</span><span class="w">    </span>
</code></pre></div>
<p>è¿™æ®µä»£ç åˆ›å»ºäº†ä¸€ä¸ªåä¸º test çš„å·¥ä½œæµï¼Œå½“å¯¹ main åˆ†æ”¯è¿›è¡Œ push çš„æ—¶å€™ä¼šè§¦å‘æ­¤å·¥ä½œæµçš„æ‰§è¡Œã€‚å·¥ä½œæµä¸­æœ‰ä¸€ä¸ªåä¸º test çš„ Jobï¼Œè¿è¡Œåœ¨ ubuntn å®¹å™¨ä¸­ï¼Œè¾“å‡º <code>Hello World</code>ã€‚(<a href="https://docs.github.com/zh/actions/using-workflows/workflow-syntax-for-github-actions">æ›´å¤šè¯­æ³•å¯å‚è€ƒè¿™é‡Œ</a>)</p>
<h2>NutUI React è‡ªåŠ¨åŒ–æµ‹è¯•</h2>
<p>NutUI React ä¸­çš„æ¯ä¸ªç»„ä»¶éƒ½æœ‰è‡ªå·±çš„å•å…ƒæµ‹è¯•ï¼Œå¹¶ä¸”å•å…ƒæµ‹è¯•è¦†ç›–ç‡æ˜¯ Review ä¸­çš„ä¸€é¡¹æŒ‡æ ‡ã€‚å•å…ƒæµ‹è¯•è¦†ç›–ç‡å¯ä»¥å€ŸåŠ© GitHub Actions è‡ªåŠ¨åŒ–æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼Œå¾—åˆ°è¦†ç›–ç‡çš„ç»“æœã€‚</p>
<p>å•å…ƒæµ‹è¯•å¯ä»¥åˆ†ä¸ºä¸¤ç§æ–¹å¼å¤„ç†ï¼šé€šè¿‡ Jest å¤„ç†å…¨éƒ¨çš„å•å…ƒæµ‹è¯•ï¼›é€šè¿‡è¯†åˆ«å˜æ›´æ–‡ä»¶ï¼Œæ‰§è¡Œç›¸å…³ç»„ä»¶çš„å•å…ƒæµ‹è¯•ã€‚NutUI React ç°åœ¨é‡‡ç”¨çš„æ˜¯è¯†åˆ«å˜æ›´æ–‡ä»¶çš„æ–¹å¼æ¥å¤„ç†å•å…ƒæµ‹è¯•ã€‚</p>
<p>è¯†åˆ«å˜æ›´æ–‡ä»¶çš„æ–¹æ¡ˆéœ€è¦å€ŸåŠ© GitHub API è§£æå‡ºå˜æ›´æ–‡ä»¶ï¼Œä¹‹åå¯¹å˜æ›´æ–‡ä»¶çš„ç‰¹å¾è¿›è¡Œå¤„ç†ï¼Œè¯†åˆ«å‡ºç»„ä»¶ï¼Œæ‰§è¡Œå•å…ƒæµ‹è¯•ã€‚</p>
<p>GitHub æä¾›äº† <a href="https://docs.github.com/zh/rest/pulls/pulls?apiVersion=2022-11-28#list-pull-requests-files"><code>/repos/{owner}/{repo}/pulls/{pull_number}/files</code></a> API ç”¨äºæŸ¥è¯¢ Pull Request çš„ç›¸å…³å†…å®¹ã€‚</p>
<p>è¦ä½¿ç”¨æ­¤ API ï¼Œæˆ‘ä»¬éœ€è¦æä¾› ownerã€repoã€pull number è¿™ä¸‰ä¸ªå‚æ•°çš„å†…å®¹ã€‚ownerã€repo å’Œ pull number å¯ä»¥é€šè¿‡ GitHub Action ä¸­çš„<a href="https://docs.github.com/zh/actions/learn-github-actions/contexts#github-context">ä¸Šä¸‹æ–‡</a>æ¥è·å–ï¼š</p>
<div class="highlight"><pre><span></span><code>name: CI

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Get PR info
        run: |
          echo &quot;PR Message github.event.number: ${{ github.event.number }}&quot;
          echo &quot;PR Message github.repository: ${{ github.repository }}&quot;
</code></pre></div>
<p>è¿™é‡Œç»™å‡ºäº†ä¸€æ®µ GitHub Action çš„è„šæœ¬ï¼Œåœ¨ <code>Get PR info</code> ä»»åŠ¡ä¸­ï¼Œå€ŸåŠ© linux çš„ echo å‘½ä»¤ï¼Œæ‰“å°æ¥ github.event.number å’Œ github.repositoryã€‚æƒ³è¦å¯¹è¿™æ®µè„šæœ¬è¿›è¡Œæµ‹è¯•ï¼Œå¯å°†å…¶æäº¤åˆ° <code>.github/workflows/test.yml</code> ä¸­ï¼Œç„¶åé€šè¿‡å…¶ä»–åˆ†æ”¯å‘ç›®æ ‡åˆ†æ”¯åˆ›å»º PRã€‚ï¼ˆå¤‡æ³¨ï¼š<code>github.event.number</code>æ¥è‡ª<a href="https://docs.github.com/zh/webhooks-and-events/webhooks/webhook-events-and-payloads#pull_request">Webhook çš„å…±æœ‰å±æ€§</a>ï¼‰</p>
<p>é€šè¿‡æ‰§è¡Œä¸Šè¿°ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¾“å‡ºçš„ PR çš„ ID å’Œ repositoryã€‚æ¥ä¸‹æ¥è¦ä½¿ç”¨ä»–ä»¬è°ƒç”¨ GitHub æä¾›çš„ APIã€‚è¿™æ®µä»£ç ä½¿ç”¨ curl è°ƒç”¨çš„ GitHub APIï¼š</p>
<div class="highlight"><pre><span></span><code>pr_number=${{ github.event.number }}
files_url=&quot;https://api.github.com/repos/${{ github.repository }}/pulls/$pr_number/files&quot;
files_response=$(curl -sSL -H &quot;Authorization: token ${{ secrets.GITHUB_TOKEN }}&quot; $files_url)
</code></pre></div>
<p>è¿™æ®µä»£ç ä¸­å³æœ‰ <code>${{ xx }}</code> åˆæœ‰ <code>$xx</code>ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåŒºåˆ†ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ä»€ä¹ˆå½¢å¼ã€‚<code>${{}}</code> æ˜¯ GitHub æä¾›çš„æ’å€¼è¡¨è¾¾å¼ï¼Œåœ¨ GitHub Actions æ‰§è¡Œçš„æ—¶å€™ä¼šå¯¹è¿™ç§è¡¨è¾¾å¼è¿›è¡Œæ±‚å€¼ã€‚<code>$xx</code> æ˜¯ Linux shell çš„å˜é‡è°ƒç”¨çš„æ–¹å¼ï¼Œåœ¨è¿™æ®µ GitHub Actions ä¸­æˆ‘ä»¬å®é™…æ‰§è¡Œçš„ä¸»è¦æ˜¯ Linux shellã€‚</p>
<p>shell å£°æ˜å˜é‡çš„æ–¹å¼å¦‚ä¸‹ï¼š
<div class="highlight"><pre><span></span><code><span class="nv">shellVariable</span><span class="o">=</span><span class="m">1</span>
</code></pre></div></p>
<p>è°ƒç”¨å˜é‡çš„æ–¹å¼å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$shellVariable</span><span class="s2">&quot;</span>
</code></pre></div>
<p>é€šè¿‡ curl è·å–åˆ° GitHub API è¿”å›çš„ç»“æœåï¼Œéœ€è¦å¯¹ç»“æœè¿›è¡Œå¤„ç†ï¼Œå³æå–å˜æ›´æ–‡ä»¶ã€‚</p>
<div class="highlight"><pre><span></span><code>files_changed=$(echo &quot;$files_response&quot; | jq -r &#39;.[].filename&#39;)
echo &quot;PR files: $files_changed&quot;
component=$(echo &quot;$files_changed&quot; |  grep -E -i &#39;src\/packages\/([a-z]+)(\/[a-z_\.]*)*&#39; | sed -E &#39;s/src\/packages\/([a-z]+)(\/[a-z_\.]*)*/\1/i&#39; | awk &#39;END{print}&#39;)
npm test -- $component
</code></pre></div>
<p>å› ä¸º GitHub API è¿”å›çš„æ˜¯ JSON æ ¼å¼ï¼š</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>
  <span class="o">{</span>
    <span class="s2">&quot;sha&quot;</span>: <span class="s2">&quot;bbcd538c8e72b8c175046e27cc8f907076331401&quot;</span>,
    <span class="s2">&quot;filename&quot;</span>: <span class="s2">&quot;src/packages/button/button.tsx&quot;</span>,
    <span class="s2">&quot;status&quot;</span>: <span class="s2">&quot;added&quot;</span>,
    <span class="s2">&quot;additions&quot;</span>: <span class="m">103</span>,
    <span class="s2">&quot;deletions&quot;</span>: <span class="m">21</span>,
    <span class="s2">&quot;changes&quot;</span>: <span class="m">124</span>,
    <span class="s2">&quot;blob_url&quot;</span>: <span class="s2">&quot;https://github.com/octocat/Hello-World/blob/6dcb09b5b57875f334f61aebed695e2e4193db5e/file1.txt&quot;</span>,
    <span class="s2">&quot;raw_url&quot;</span>: <span class="s2">&quot;https://github.com/octocat/Hello-World/raw/6dcb09b5b57875f334f61aebed695e2e4193db5e/file1.txt&quot;</span>,
    <span class="s2">&quot;contents_url&quot;</span>: <span class="s2">&quot;https://api.github.com/repos/octocat/Hello-World/contents/file1.txt?ref=6dcb09b5b57875f334f61aebed695e2e4193db5e&quot;</span>,
    <span class="s2">&quot;patch&quot;</span>: <span class="s2">&quot;@@ -132,7 +132,7 @@ module Test @@ -1000,7 +1000,7 @@ module Test&quot;</span>
  <span class="o">}</span>
<span class="o">]</span>
</code></pre></div>
<p>æ‰€ä»¥æˆ‘ä»¬é€šè¿‡ jq ä» GitHub API è¿”å›çš„ç»“æœä¸­æå–æˆ‘ä»¬éœ€è¦çš„æ•°æ®ï¼Œå³ç¬¬ä¸€è¡Œä»£ç ä¸­çš„ <code>jq -r '.[].filename</code>ï¼Œè¿™å¥ä»£ç çš„æ„æ€æ˜¯å– <code>filename</code> å­—æ®µçš„å€¼ï¼Œç„¶åä»¥åŸå§‹æ–‡æœ¬å½¢å¼è¿”å›ã€‚å¯¹äºä¸Šé¢çš„ JSON æ•°æ®ï¼Œjq çš„å¤„ç†ç»“æœæ˜¯ï¼š<code>src/packages/button/button.tsx</code>ã€‚ï¼ˆ<a href="https://www.tutorialspoint.com/guide-to-linux-jq-command-for-json-processing">jq ä»‹ç»</a>ï¼‰</p>
<p>è·å–å˜æ›´æ–‡ä»¶åï¼Œè¿˜éœ€è¦å°†<code>src/packages/button/button.tsx</code>ä¸­çš„ button æå–å‡ºæ¥ï¼Œä»¥ä¾¿ä¼ é€’ç»™ npm è„šæœ¬ã€‚å¯¹äºå˜æ›´æ–‡ä»¶çš„å¤„ç†ï¼Œä¸»è¦å€ŸåŠ© Linux ä¸­çš„ grepã€sedã€awkã€‚</p>
<p><code>grep -E -i</code> è¡¨ç¤ºä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¹¶ä¸”å¿½ç•¥å¤§å°å†™ã€‚
<code>sed -E</code> åŒæ ·è¡¨ç¤ºä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œä½†æ˜¯å®ƒçš„å¿½ç•¥å¤§å°å†™æ˜¯å†™åˆ°åé¢çš„å‚æ•°ä¸­ã€‚</p>
<p>åˆ°è¿™å°±å®Œæˆäº† GitHub Actions çš„ workflowï¼Œé™¤äº†é€šè¿‡ GitHub API çš„æ–¹å¼æ¥è·å–å˜æ›´æ–‡ä»¶å¤–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å¯¹åˆ†æ”¯è¿›è¡Œå¯¹æ¯”è·å–å˜æ›´æ–‡ä»¶ã€‚</p>
        </article>
        
    </body>
</html>
